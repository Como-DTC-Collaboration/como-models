---
title: "Optimisation of London data with SEIRD model"
author: "Chon Lok Lei and Hui Jia Farm"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(comomodels)
library(ggplot2)
library(glue)
library(dplyr)
library(tidyr)
```

## Load London data
```{r}
# Depending on the working directory
# Yet to set a generic one
setwd("..")
df_london = read.csv('./data/London_data.csv', header = TRUE)

# Extracting cases and deaths and renaming columns
#London
cases_deaths_name_london = c('newCasesBySpecimenDate', 'newDailyNsoDeathsByDeathDate')
df_london = df_london[cases_deaths_name_london]
names(df_london)[names(df_london) == "newCasesBySpecimenDate"] <- "DailyCases"
names(df_london)[names(df_london) == "newDailyNsoDeathsByDeathDate"] <- "DailyDeaths"

London_population <- 9e6
```

Plot of London data
```{r, fig.height = 5, fig.width = 7}
# plot (df_london$DailyCases[42:82], type = 'l')
# plot (df_london$DailyDeaths[42:82], type = 'l')

London = df_london[42:82, 1:2] # Start of lockdown (23/03/2020) is 83rd day
print(head(London, 10))
rownames(London) = seq(length=nrow(London))
London$time <- seq(length=nrow(London))


ggplot() +
  geom_line(data=London, aes(x = time, y = DailyCases, color="Incidence")) +
  geom_line(data=London, aes(x = time, y = DailyDeaths, color="Deaths")) +
  scale_color_manual(name = "Legend", values = c("Incidence" = "#FF6699", "Deaths" = "#66CCFF")) +
  # scale_color_brewer(palette = "Dark2") +
  labs(x = "time (days)", y = "number of cases",
       title = glue("Incidences and deaths over time"))
```

## Create error function
```{r}
ErrorFn <- function(parameters) {
    
    transmission_para <- list(beta=parameters[1],
                              kappa=parameters[2],
                              gamma=parameters[3],
                              mu=parameters[4])
    init_cond <- list(S0=parameters[5],
                      E0=parameters[6],
                      I0=parameters[7],
                      R0=1-sum(parameters[5:7]))
    
    my_model <- SEIRD()
    
    transmission_parameters(my_model) <- transmission_para
    initial_conditions(my_model) <- init_cond
  
    times <- seq(0, length(London$DailyCases), by = 1)
    out_df <- run(my_model, times)
    
    data_wide <- spread(out_df$changes, compartment, value)
    data_wide$Incidence <- data_wide$Incidence * London_population
    data_wide$Deaths <- data_wide$Deaths * London_population
    
    incidence_err <- sqrt(sum((London$DailyCases - data_wide$Incidence[-1])^2))
    death_err <- sqrt(sum((London$DailyDeaths - data_wide$Deaths[-1])^2))
    
    (incidence_err + death_err)/2
}
```

## Optimisation
```{r}
repeat_num <- 100
# guess1 <- c(0.35, 0.1, 0.05, 0.05)
# guess2 <- c(0.5, 0.5, 0.2, 0.2)
for (repeats in 1:repeat_num){
    # if (repeats == 1){
    #   trans_params_guess <- guess1
    # } else {
    #   trans_params_guess <- guess2
    # }
    trans_params_guess <- runif(4, min = 0, max = 1)
    init_conds_guess<- c(1-3e-7, 1e-7, 1e-7, 1e-7)
    constraint_ui <- rbind(diag(8), -diag(8), c(rep(0, 4), rep(1,4)), c(rep(0, 4), rep(-1,4)))
    constraint_ci <- c(rep(0, 8), rep(-1, 8), 0.99, -1.01)
    
    result <- constrOptim(c(trans_params_guess, init_conds_guess), ErrorFn,
                'NULL', constraint_ui, constraint_ci,
                method = "Nelder-Mead")
    if (repeats == 1){
    optimised_para <- data.frame("beta" = result$par[1], "kappa" = result$par[2], "gamma" = result$par[3], "mu" = result$par[4], "S0" = result$par[5], "E0" = result$par[6], "I0" = result$par[7], "R0" = result$par[8], "obj_fn" = result$value)
    initial_guesses <- data.frame("beta" = trans_params_guess[1], "kappa" = trans_params_guess[2], "gamma" = trans_params_guess[3], "mu" = trans_params_guess[4])
    } else {
    optimised_para <- rbind(optimised_para, c("beta" = result$par[1], "kappa" = result$par[2], "gamma" = result$par[3], "mu" = result$par[4], "S0" = result$par[5], "E0" = result$par[6], "I0" = result$par[7], "R0" = result$par[8], "obj_fn" = result$value))
    initial_guesses <- rbind(initial_guesses, c("beta" = trans_params_guess[1], "kappa" = trans_params_guess[2], "gamma" = trans_params_guess[3], "mu" = trans_params_guess[4]))
    }
}
```

```{r, fig.height = 5, fig.width = 7}
for (repeats in 1:repeat_num){
    
    my_model <- SEIRD()
        
    transmission_parameters(my_model) <- optimised_para[repeats, 1:4]
    initial_conditions(my_model) <- optimised_para[repeats, 5:8]
    
    times <- seq(0, length(London$DailyCases)*5, by = 1)
    out_df <- run(my_model, times)
    
    cases <- out_df$changes
    cases$value <- cases$value * London_population
    cases$repeat_id <- rep(repeats, length(cases$time))
    
    if (repeats == 1){
      cases_repeats <- cases
    } else{
      cases_repeats <- rbind(cases_repeats, cases)
    }

    # cases <- spread(cases, compartment, value)
    # 
    # cases$Deaths <- cases$Deaths * London_population
    # cases <- cases[-1,]
    # 
    # London$time <- cases$time[1:length(London$DailyCases)]
}
# print(cases_repeats[cases_repeats$repeat_id == 1,])
# ggplot(cases_repeats, aes(time, value, color=compartment)) + geom_line()
cases_repeats <- spread(cases_repeats, compartment, value)
b <- ggplot()
for (i in 1:repeat_num){
  data_set <- cases_repeats[cases_repeats$repeat_id == i,]
  b <- b + geom_line(data=data_set, aes(x = time, y = Incidence, color="Optimised Incidence")) +
  geom_line(data=data_set, aes(x = time, y = Deaths, color="Optimised Deaths"))
}
b <- b +scale_color_manual(name = "Legend", values = c("Optimised Incidence" = "red", "Optimised Deaths" = "blue", "Actual Incidence" = "#FF6699", "Actual Deaths" = "#66CCFF")) +
  # scale_color_brewer(palette = "Dark2") +
  labs(x = "time (days)", y = "number of cases",
       title = glue("Incidences and deaths over time"))
print(b)
```

## Plot box plot of estimated variables
```{r}
# plotting_data <- subset(optimised_para, select=-c(obj_fn))
plotting_data <- subset(optimised_para, select=c(beta, kappa, gamma, mu))
plotting_data$index <- seq(1, repeat_num)
plotting_data$id <- rep("optimised", repeat_num)
initial_guesses$index <- seq(1, repeat_num)
initial_guesses$id <- rep("guesses", repeat_num)
data <- rbind(plotting_data, initial_guesses)
data <- gather(data, key="parameters", value="value", -c(index, id))
ggplot(data, aes(x=parameters, y=value, fill=id)) +
    geom_boxplot()
```

```{r}
boxplot(optimised_para$obj_fn)
```

