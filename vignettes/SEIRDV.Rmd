---
title: "The SEIRDV model"
author: "Ioana Bouros"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{The SEIRV model}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(comomodels)
library(ggplot2)
library(glue)
library(dplyr)
```

## Introduction
This document explains the basics of the SEIR model. The model describes
how populations of susceptible, exposed, infectious, recovered and vaccinated
individuals evolve over time. Waning immunity is also considered in this model,
so there is a constant supply of susceptibles in the population and make the model
more realistic.

## The SEIRDV Model
The SEIRDV model consists of five ODEs describing five populations of susceptible,
recovered, infectious, recovered and vaccinated individuals. Susceptible
individuals ($S$) have not been exposed to the virus. Exposed individuals ($E$) have been
exposed to the virus and have been infected but are not yet infectious to others; they are 
in the incubation period. Infectious individuals ($I$) can spread the virus to 
others.  Recovered individuals ($R$) are no longer
infectious, but they can return to the susceptible population when they lose their
immunity. Vaccinated individuals ($R$) cannot become infected and are not ill at
the time, but as it was the case with the recovered population, their immunity
is temporarily and can become susceptible again with a certain rate. Births and
deaths unrelated to the infection are not considered in this model. The ODEs describing
how the five populations evolve over time are
$$\frac{\text{d}S}{\text{d}t} = -\beta S I - \nu S + \delta_V V + \delta_R R,$$
$$\frac{\text{d}E}{\text{d}t} = \beta S I -\kappa E,$$
$$\frac{\text{d}I}{\text{d}t} = \kappa E - (\gamma + \mu) I,$$
$$\frac{\text{d}R}{\text{d}t} = \gamma I - \delta_R R,$$
$$\frac{\text{d}V}{\text{d}t} = \nu S - \delta_V V$$
where $\beta$, $\kappa$, $\gamma$, $\mu$, $\nu$, $\delta_V$ and $\delta_R$ are
positive parameters. The rate at which susceptible individuals are infected
depends on the fraction of the population that is susceptible, the fraction of
the population that is infectious, and the probability of an infectious individual
infecting a susceptible individual, $\beta$. This is represented in the
first terms on the right-hand side of $\text{d}S/ \text{d}t$ and $\text{d}E/ \text{d}t$.
Exposed individuals become infectious at rate $\kappa$. $1/ \kappa$ is
the incubation time of the virus, i.e. how many days after exposure the individual
becomes infectious to others. Infectious individuals can either recover or die
because of the disease. Infectious individuals recover in $1/ \gamma$
days, thus individuals recover at rate $\gamma$. Similarly, infectious
individuals die due to the infection after $1/ \mu$ days, making the death rate $\mu$.
Individuals are vaccinated at rate $\nu$. Among those who are immune (
recovered and vaccinated), people lose their immunity against the virus at different
rates depending on what type of immunity they acquired: $\delta_V$ for those vaccinated
and $\delta_R$ respectively for those previously infected.

In addition to these four main ODEs, the model also keeps track of the cumulative number 
of cases ($C$) and the cumulative number of disease-related deaths ($D$) over time
$$\frac{\text{d}C}{\text{d}t} = \beta S I,$$
$$\frac{\text{d}D}{\text{d}t} = \mu I.$$

The system is closed by specifying the initial conditions
$$S(0) = S_0,\ E(0) = E_0,\ I(0) = I_0,\ R(0) = R_0,\ V(0) = V_0,\ C(0) = C_0,\ D(0) = D_0,$$
where $C_0 = E_0 + I_0 + R_0$ to ensure the cases that occur before $t=0$ are
also counted.
In the implementation of the model in this package, the variables are normalized so 
$S(t) + E(t) + I(t) + R(t) + V(t) + D(t) \equiv 1$ for any given $t$. This means that each of these state variables represents the fraction of the population in each of these states at a given point in time.

We next illustrate how this model works using functionality available in `comomodels`.

## The `SEIRDV` class

We first create an `SEIRDV` object that we will use to run simulations.
```{r}
my_model <- SEIRDV()
```

Next, we set the parameter values for $\beta$, $\kappa$, $\gamma$, $\mu$, $\nu$,
$\delta_V$ and $\delta_R$:
```{r}
params <- list(beta=1, kappa=0.9, gamma=0.5, mu=0.1, nu=0.4, delta_V=0.1,
               delta_R=0.05)
transmission_parameters(my_model) <- params
```

To check that the parameters have been set correctly, we call
```{r}
transmission_parameters(my_model)
```

We now need to set the initial conditions for the model. We only set the initial conditions $S(0)$, $E(0)$, $I(0)$, $R(0)$ and $V(0)$.
```{r}
initial_conditions(my_model) <- list(S0=0.99, E0=0, I0=0.01, R0=0, V0=0)
```
The initial conditions must sum to one. If they do not, an error is thrown.

Now we simulate the system from $t=0$ days to $t=50$ days.
```{r}
times <- seq(0, 50, by = 1)
out_df <- run(my_model, times)
```

The simulation returns two objects: one is a data frame comprising the states over time. Here, there's a peak in the infectious proportion between $t=15$ and $t=20$.
```{r, fig.height = 5, fig.width = 7}
states <- out_df$states

ggplot(states, aes(x = time, y = value)) +
  geom_line(aes(color = compartment)) +
  scale_color_brewer(palette = "Dark2") +
  labs(x = "time (days)", y = "fraction of the population",
       title = glue("Evolution of different compartments over time"))
```

The simulation also outputs incidence and deaths. These are derived from the state variables. Incidence is just the difference between the cumulative number of cases between two time points,

$$ \text{incidence(t)} = C(t) - C(t - 1),$$

since this shows the number of cases which have arisen between these time  points. Deaths are also given by a difference, but, in this instance, between the cumulative number of deaths at two consecutive time points:

$$ \text{deaths(t)} = D(t) - D(t - 1).$$

```{r fig2, fig.height = 5, fig.width = 7}
changes <- out_df$changes

ggplot(changes, aes(x = time, y = value, fill = compartment)) +
  geom_bar(stat="identity", position = position_dodge()) +
  labs(x = "time (days)", y = "fraction of the population per day",
       title = glue("Incidences and deaths")) +
  theme(legend.position = "bottom", legend.title = element_blank())

```

## Sensitivity analysis
In this section, we investigate the sensitivity of the number of deaths to the transmission rate, $\beta$. We run the model for varying values of $\beta$ and plot the
number of deaths per day over time.
```{r, fig.height = 5, fig.width = 7}
# function to setup and run model for different beta values
run_seird <- function(beta_val) {
  inits <- list(S0=0.99, E0=0, I0=0.01, R0=0, V0=0)
  params <- list(beta=beta_val, kappa=0.9, gamma=0.5, mu=0.1, nu=0.4, delta_V=0.1,
                 delta_R=0.05)
  model <- SEIRDV(initial_conditions = inits,
                transmission_parameters=params)
  times <- seq(0, 50, by = 1)
  out_df <- run(model, times)
  out_df$changes
}

# run model across different beta values
beta_vals <- c(0.1, 0.5, 0.75, 1, 2)
for(i in seq_along(beta_vals)) {
  beta_temp <- beta_vals[i]
  temp <- run_seird(beta_temp) %>% mutate(beta=beta_temp)
  if(i == 1)
    result <- temp %>% mutate(beta=beta_temp)
  else
    result <- result %>% bind_rows(temp)
}

# plot results
result %>% 
  filter(compartment=="Deaths") %>% 
  ggplot(aes(x=time, y=value, fill = as.factor(beta))) +
  geom_bar(stat = "identity", position = position_dodge()) +
  labs(x = "time (days)", y = "Fraction of the population that died per day",
       title = glue("Number of deaths for differing values of beta")) +
  theme(legend.position = "bottom", legend.title = element_blank())

```
We now investigate the sensitivity of the number of deaths to the vaccination rate, $\nu$. We run the model for varying values of $\nu$ and plot the
number of deaths per day over time.
```{r, fig.height = 5, fig.width = 7}
# function to setup and run model for different nu values
run_seird <- function(nu_val) {
  inits <- list(S0=0.99, E0=0, I0=0.01, R0=0, V0=0)
  params <- list(beta=1, kappa=0.9, gamma=0.5, mu=0.1, nu=nu_val, delta_V=0.1,
                 delta_R=0.05)
  model <- SEIRDV(initial_conditions = inits,
                transmission_parameters=params)
  times <- seq(0, 50, by = 1)
  out_df <- run(model, times)
  out_df$changes
}

# run model across different nu values
nu_vals <- c(0.1, 0.25, 0.5, 0.75, 1)
for(i in seq_along(nu_vals)) {
  nu_temp <- nu_vals[i]
  temp <- run_seird(nu_temp) %>% mutate(nu=nu_temp)
  if(i == 1)
    result <- temp %>% mutate(nu=nu_temp)
  else
    result <- result %>% bind_rows(temp)
}

# plot results
result %>% 
  filter(compartment=="Deaths") %>% 
  ggplot(aes(x=time, y=value, fill = as.factor(nu))) +
  geom_bar(stat = "identity", position = position_dodge()) +
  labs(x = "time (days)", y = "Fraction of the population that died per day",
       title = glue("Number of deaths for differing values of beta")) +
  theme(legend.position = "bottom", legend.title = element_blank())

```
