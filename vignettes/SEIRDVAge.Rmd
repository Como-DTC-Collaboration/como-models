---
title: "The SEIRDVAge model"
author: "Ioana Bouros"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{The SEIRDVAge model}
  %\VignetteEngine{knitr::knitr}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(comomodels)
library(tidyverse)
library(ggplot2)
library(glue)
library(dplyr)
```

## Introduction
This document explains the basics of the SEIRV model with age structure. The model describes
how populations of susceptible, exposed, infectious, recovered and vaccinated
individuals evolve over time. Waning immunity is also considered in this model,
so there is a constant supply of susceptibles in the population which makes the model
more realistic. Contact data and age structure are also considered in the model.

However, in reality, a susceptible individual from a given age class
can become infected from any age class: to capture this aspect of the model, infected individuals of any
age are supposed to inter-mix, with the mixing rate dictated by a so-called "contact matrix", $C$.

The elements of contact matrices, $C_{i,j}$ indicate the expected number of contacts an individual of age class $i$ experiences with age class $j$ per day. In this package, we include country-level estimates of contact matrices (Prem et al., 2017; for full details see data documentation). There are actually four types of contact matrix corresponding to daily numbers of contacts at home, work, school and all other settings. Here, we visualise these for India.
```{r}
load(file = "../data/contact_home.rda")
load(file = "../data/contact_work.rda")
load(file = "../data/contact_school.rda")
load(file = "../data/contact_other.rda")
```

```{r, fig.width=10, fig.height=8}
# reformat matrices for plotting
ages <- seq(0, 80, 5)
age_names <- vector(length = 16)
for(i in seq_along(age_names)) {
  age_names[i] <- paste0(ages[i], "-", ages[i + 1])
}
format_matrix <- function(contact_matrix, age_names) {
  colnames(contact_matrix) <- age_names
  contact_matrix$age_infectee <- age_names
  contact_matrix %>%
    pivot_longer(all_of(age_names)) %>% 
    rename(age_infector=name) %>% 
    mutate(age_infector=fct_relevel(age_infector, age_names)) %>% 
    mutate(age_infectee=fct_relevel(age_infectee, age_names))
}
c_home <- format_matrix(contact_home$India, age_names) %>% mutate(type="home")
c_work <- format_matrix(contact_work$India, age_names) %>% mutate(type="work")
c_school <- format_matrix(contact_school$India, age_names) %>% mutate(type="school")
c_other <- format_matrix(contact_other$India, age_names) %>% mutate(type="other")
c_all <- c_home %>%
  bind_rows(c_work) %>% 
  bind_rows(c_school) %>% 
  bind_rows(c_other)
# plot all
c_all %>%
  ggplot(aes(x=age_infector, y=age_infectee, fill=value)) +
  xlab("age group of infector") + ylab("age group of infectee") +
  theme(text = element_text(size=20),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  geom_tile() +
  scale_fill_viridis_c() +
  facet_wrap(~type)
```

We can see that the majority of contacts fall between younger individuals, occurring at home or "other" locations. At home, however, there is more substantial intergenerational mixing than in other settings.

The model we introduce here does not compartmentalise individuals according to location, so we make an overall contact matrix by summming these together.
```{r, fig.width=8, fig.height=5}
c_combined <- c_all %>% 
  group_by(age_infectee, age_infector) %>% 
  summarise(value=sum(value))
c_combined %>% 
  ggplot(aes(x=age_infector, y=age_infectee, fill=value)) +
  xlab("age group of infector") + ylab("age group of infectee") +
  theme(text = element_text(size=20),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  geom_tile() +
  scale_fill_viridis_c()
```

We now use this contact matrix to allow infections to pass between age groups. To do so, we amend the governing equations for the susceptibles and exposed individuals within age class $i$:

\begin{align}
\frac{\text{d}S_i}{\text{d}t} &= -\beta S_i \Sigma_{j}C_{ij} I_j\\
\frac{\text{d}E_i}{\text{d}t} &= \beta S_i \Sigma_{j}C_{ij} I_j -\kappa E_i\\
\end{align}

Specifically, the term $S_i \Sigma_{j}C_{ij} I_j$ effectively indicates the expected number of contacts between susceptible individuals of age class $i$ with infected individuals across all classes.


## The SEIRDVAge Model
The SEIRDVAge model consists of five ODEs describing five populations of susceptible,
recovered, infectious, recovered and vaccinated individuals. Susceptible
individuals ($S$) have not been exposed to the virus. Exposed individuals ($E$) have been
exposed to the virus and have been infected but are not yet infectious to others; they are 
in the incubation period. Infectious individuals ($I$) can spread the virus to 
others.  Recovered individuals ($R$) are no longer
infectious, but they can return to the susceptible population when they lose their
immunity. Vaccinated individuals ($V$) cannot become infected and are not ill at
the time, but as it was the case with the recovered population, their immunity
is temporary and they can become susceptible again with a certain rate. 
We can vaccinate not only the susceptibles, but also $E$, $I$ and $R$s. However,
they have already been exposed to the illness so they do not change compartment
assignment. Births and deaths unrelated to the infection are not considered in
this model. The ODEs describing how the five populations evolve over time are
$$\frac{\text{d}S_i}{\text{d}t} = -\beta S_i \Sigma_{j}C_{ij} I_j - \nu \text{Inter}(t) S_i + \delta_{V} V_i + \delta_{R} R_i + \delta_{VR} VR_i,$$
$$\frac{\text{d}E_i}{\text{d}t} = \beta S_i \Sigma_{j}C_{ij} I_j -\kappa E_i,$$
$$\frac{\text{d}I_i}{\text{d}t} = \kappa E_i - (\gamma + \mu) I_i,$$
$$\frac{\text{d}R_i}{\text{d}t} = \gamma I_i - \delta_R R_i - \nu Inter(t) R_i,$$
$$\frac{\text{d}V_i}{\text{d}t} = \nu Inter(t) S_i - \delta_V V_i$$
$$\frac{\text{d}VR_i}{\text{d}t} = \nu Inter(t) R_i - \delta_{VR} VR_i$$

where $\beta$, $\kappa$, $\gamma$, $\mu$, $\nu$, $\delta_V$, $\delta_R$ and $\delta_{VR}$ are
positive parameters. The rate at which susceptible individuals are infected
depends on the fraction of the population that is susceptible, the fraction of
the population that is infectious, and the odds of an infectious individual
infecting a susceptible individual, $\beta$. This is represented in the
first terms on the right-hand side of $\text{d}S/ \text{d}t$ and $\text{d}E/ \text{d}t$.
Exposed individuals become infectious at rate $\kappa$. $1/ \kappa$ is
the incubation time of the virus, i.e. how many days after exposure the individual
becomes infectious to others. Infectious individuals can either recover or die
because of the disease. Infectious individuals recover in $1/ \gamma$
days, thus individuals recover at rate $\gamma$. Similarly, infectious
individuals die due to the infection after $1/ \mu$ days, making the death rate $\mu$.
Susceptible individuals are vaccinated at a maximum rate $\nu$. Among those who are immune
(recovered and vaccinated), people lose their immunity against the virus at different
rates depending on what type of immunity they acquired: $\delta_V$ for those vaccinated,
$\delta_R$ for those previously infected and $\delta_VR$ for those previously infected that
received the vaccine after they recovered. $Inter(t)$ is the value
at time t of the intervention protocol defined by the intervention parameters.

In addition to these five main ODEs, the model also keeps track of the cumulative number 
of cases ($C$) and the cumulative number of disease-related deaths ($D$) over time
$$\frac{\text{d}C_i}{\text{d}t} = \beta S_i \Sigma_{j}C_{ij} I_j,$$
$$\frac{\text{d}D_i}{\text{d}t} = \mu I_i.$$

The system is closed by specifying the initial conditions
$$S(0) = S_0,\ E(0) = E_0,\ I(0) = I_0,\ R(0) = R_0,\ V(0) = V_0, VR(0) = VR_0,\ C(0) = 0,\ D(0) = 0.$$
In the implementation of the model in this package, the variables are normalized so 
$S(t) + E(t) + I(t) + R(t) + V(t) + VR(t) + D(t) \equiv 1$ for any given $t$. This means that each of these state variables represents the fraction of the population in each of these states at a given point in time.

We next illustrate how this model works using functionality available in `comomodels`.

## The `SEIRDVAge` class

## Simulation examples 

Now we create a model that includes this age-structured mixing. Since the contact matrices have 16 age classes, we instantiate a model with this number of classes. We also give it transmission parameters, populate the age classes with initial conditions and use our overall contact matrix.

We use country-level demographics from the UN and, for this example, initialise the model with a uniform initial infected population of 1% across all age groups. The remaining 99% of the population starts
as susceptible.
```{r}
load(file = "../data/population.rda")
# use demographic data to create normalised population fractions
pops = population[population$country == 'India', ]$pop
pop_fraction = pops/sum(pops)
## the contact matrix has an upper group of 80+, so we sum the remaining fractions beyond this point
pop_fraction[16] = sum(pop_fraction[16:21])
pop_fraction = pop_fraction[1:16]
# reshape contact matrix into 16x16 form
n_ages <- 16
c_combined_wider <- c_combined %>% 
  pivot_wider(id_cols = age_infectee, names_from = age_infector,
              values_from=value) %>% 
  ungroup() %>% 
  select(-age_infectee) %>% 
  as.matrix()

# create model
my_model <- SEIRDVAge()
```

Next, we set the parameter values for $\beta$, $\kappa$, $\gamma$, $\mu$, $\nu$,
$\delta_V$, $\delta_R$ and $\delta_{VR}$:
```{r}
params <- list(beta=1, kappa=0.9, gamma=0.5, mu=0.1, nu=0.4, delta_V=0.1,
               delta_R=0.05, delta_VR = 0.02)
transmission_parameters(my_model) <- params
```

To check that the parameters have been set correctly, we call
```{r}
transmission_parameters(my_model)
```

We now need to set the initial conditions for the model. We only set the initial conditions $S(0)$, $E(0)$, $I(0)$, $R(0)$, $V(0)$ and $VR(0)$.
```{r}
initial_conditions(my_model) <- list(S0=0.99, E0=0, I0=0.01, R0=0, V0=0, VR0=0)
```
The initial conditions must sum to one. If they do not, an error is thrown.

Now we simulate the system from $t=0$ days to $t=200$ days.
```{r}
intervention_parameters(my_model) <- list(starts=c(17, 35, 42),
                                          stops=c(25, 39, 49),
                                          coverages=c(1, 1, 1))
times <- seq(0, 200, by = 1)
out_df <- run(my_model, times)
```
The added intervention feature allows for variable levels of vaccination in a population.
In most cases, a vaccine is not available or considered necessary right from the
start of an epidemic so there is a delay in vaccination. Similarly, vaccination
programs may not run at the same rate all the time, so such fluctuations need to
be taken into account in our modeling.

Below we can see a plot of the level of interventions that occur at each time step.
```{r, fig.height = 5, fig.width = 7}
int_parms <- InterventionParameters(start=c(17, 35, 42),
                                    stop=c(25, 39, 49),
                                    coverage=c(1, 1, 1))

sim_parms <- SimulationParameters(start=0, stop=200, tstep = 0.1)

intervention_protocol(int_parms, sim_parms, 1) %>%
  ggplot(aes(x=time, y=coverage)) +
  geom_line() +
  scale_color_brewer(palette = "Dark2") +
  labs(x = "time (days)", y = "level of intervention") +
  theme(text = element_text(size = 20))
```
Interventions for this model last several days at least and have several days between them.

The simulation returns two objects: one is a data frame comprising the states over time. Here, the infectious proportion is steadily declining, plummeting to 0 after $t=20$.
```{r, fig.height = 5, fig.width = 7}
states <- out_df$states

sv <- subset(states, states$compartment %in% c("S", "V"))
ggplot(sv, aes(x = time, y = value)) +
  geom_line(aes(color = compartment)) +
  scale_color_brewer(palette = "Dark2") +
  labs(x = "time (days)", y = "fraction of the population") +
  theme(text = element_text(size = 20))    

eird <- subset(states, !states$compartment %in% c("S", "V"))
ggplot(eird, aes(x = time, y = value)) +
  geom_line(aes(color = compartment)) +
  scale_color_brewer(palette = "Dark2") +
  labs(x = "time (days)", y = "fraction of the population") +
  theme(text = element_text(size = 20))    
```

The simulation also outputs incidence and deaths. These are derived from the state variables. Incidence is just the difference between the cumulative number of cases between two time points,

$$ \text{incidence(t)} = C(t) - C(t - 1),$$

since this shows the number of cases which have arisen between these time  points. Deaths are also given by a difference, but, in this instance, between the cumulative number of deaths at two consecutive time points:

$$ \text{deaths(t)} = D(t) - D(t - 1).$$

```{r fig2, fig.height = 5, fig.width = 7}
changes <- out_df$changes

ggplot(changes, aes(x = time, y = value, fill = compartment)) +
  geom_bar(stat="identity", position = position_dodge()) +
  scale_color_brewer(palette = "Dark2") +
  labs(x = "time (days)", y = "fraction of the population \n per day") +
  theme(legend.position = "bottom", legend.title = element_blank(),
        text = element_text(size = 20))

```

## Sensitivity analysis
In this section, we investigate the sensitivity of the number of deaths to the loss-of-immunity rate
in vaccinated individuals, $\delta_V$. We run the model for varying values of $\delta_V$ and plot the
number of deaths per day over time.
```{r, fig.height = 5, fig.width = 7}
# function to setup and run model for different delta_V values
run_SEIRDVAge <- function(delta_V_val) {
  inits <- list(S0=0.99, E0=0, I0=0.01, R0=0, V0=0, VR0=0)
  params <- list(beta=1, kappa=0.9, gamma=0.5, mu=0.1, nu=0.4, delta_V=delta_V_val,
                 delta_R=0.05, delta_VR = 0.02)
  interv<- list(starts=c(17, 35, 42),
                stops=c(25, 39, 49),
                coverages=c(1, 1, 1))
  model <- SEIRDVAge(initial_conditions = inits,
                transmission_parameters=params,
                intervention_parameters = interv)
  times <- seq(0, 200, by = 1)
  out_df <- run(model, times)
  out_df$changes
}

# run model across different delta_V values
delta_V_vals <- c(0.1, 0.05, 0.01, 0.2, 0.5)
for(i in seq_along(delta_V_vals)) {
  delta_V_temp <- delta_V_vals[i]
  temp <- run_SEIRDVAge(delta_V_temp) %>% mutate(delta_V=delta_V_temp)
  if(i == 1)
    result <- temp %>% mutate(delta_V=delta_V_temp)
  else
    result <- result %>% bind_rows(temp)
}

# plot results
result %>% 
  filter(compartment=="Deaths") %>% 
  ggplot(aes(x=time, y=value, color = as.factor(delta_V))) +
  geom_line(stat = "identity", position = position_dodge()) +
  scale_color_brewer(palette = "Dark2") +
  labs(x = "time (days)", y = "fraction of the population \n that died per day") +
  theme(legend.position = "bottom", legend.title = element_blank(),
        text=element_text(size=20))

```
As we can see from the plot above, larger rates of immunity decay $\delta_V$ in vaccinated
individuals make the second wave of the number of deaths in the epidemic occur much closer to the first
peak. For smaller $\delta_V$, we see no deaths for larger stretches of time.

We now investigate the sensitivity of the number of deaths to the maximum vaccination rate, $\nu$. We run the model for varying values of $\nu$ and plot the
number of deaths per day over time.
```{r, fig.height = 5, fig.width = 7}
# function to setup and run model for different nu values
run_SEIRDVAge <- function(nu_val) {
  inits <- list(S0=0.99, E0=0, I0=0.01, R0=0, V0=0, VR0=0)
  params <- list(beta=1, kappa=0.9, gamma=0.5, mu=0.1, nu=nu_val, delta_V=0.1,
                 delta_R=0.05, delta_VR = 0.02)
  interv<- list(starts=c(17, 35, 42),
                stops=c(25, 39, 49),
                coverages=c(1, 1, 1))
  model <- SEIRDVAge(initial_conditions = inits,
                transmission_parameters=params,
                intervention_parameters = interv)
  times <- seq(0, 200, by = 1)
  out_df <- run(model, times)
  out_df$changes
}

# run model across different nu values
nu_vals <- c(0.1, 0.25, 0.5, 0.75, 1)
for(i in seq_along(nu_vals)) {
  nu_temp <- nu_vals[i]
  temp <- run_SEIRDVAge(nu_temp) %>% mutate(nu=nu_temp)
  if(i == 1)
    result <- temp %>% mutate(nu=nu_temp)
  else
    result <- result %>% bind_rows(temp)
}

# plot results
result %>% 
  filter(compartment=="Deaths") %>% 
  ggplot(aes(x=time, y=value, color = as.factor(nu))) +
  geom_line(stat = "identity", position = position_dodge()) +
  scale_color_brewer(palette = "Dark2") +
  labs(x = "time (days)", y = "fraction of the population \n that died per day") +
  theme(legend.position = "bottom", legend.title = element_blank(),
        text=element_text(size=20))

```
As we can see from the plot above, larger rates of maximum vaccination $\nu$ make the second wave of the number of deaths in the epidemic occur much further to the first peak. For larger $\nu$, we see no deaths for larger stretches of time, even though the second peak is larger.

We now investigate the sensitivity of the start time of intervention values, `start_val`. We run the model for varying values of `start_val` and plot the number of deaths per day over time.

For this investigation, we are switching to a new intervention that starts at start_val and continues to 100, rather than the one you've been using previously
```{r, fig.height = 5, fig.width = 7}
# function to setup and run model for different start intervention values
run_SEIRDVAge <- function(start_val) {
  inits <- list(S0=0.99, E0=0, I0=0.01, R0=0, V0=0, VR0=0)
  params <- list(beta=1, kappa=0.9, gamma=0.5, mu=0.1, nu=0.4, delta_V=0.1,
                 delta_R=0.05, delta_VR = 0.02)
  interv<- list(starts=start_val,
                stops=100,
                coverages=1)
  model <- SEIRDVAge(initial_conditions = inits,
                transmission_parameters=params,
                intervention_parameters = interv)
  times <- seq(0, 200, by = 1)
  out_df <- run(model, times)
  out_df$changes
}

# run model across different start_val values
start_val <- c(0, 5, 10, 15, 20, 30, 45, 55)
for(i in seq_along(start_val)) {
  start_temp <- start_val[i]
  temp <- run_SEIRDVAge(start_temp) %>% mutate(starts=start_temp)
  if(i == 1)
    result <- temp %>% mutate(starts=start_temp)
  else
    result <- result %>% bind_rows(temp)
}

# plot results
result %>% 
  filter(compartment=="Deaths") %>% 
  ggplot(aes(x=time, y=value, color = as.factor(starts))) +
  geom_line(stat = "identity", position = position_dodge()) +
  scale_color_brewer(palette = "Dark2") +
  labs(x = "time (days)", y = "fraction of the population \n that died per day") +
  theme(legend.position = "bottom", legend.title = element_blank(),
        text=element_text(size=20))

```
As we can see from the plot above, larger start time of intervention values, `start_val` produces deaths for much longer and the peak of their number is higher than in the case of smaller `start_val`.