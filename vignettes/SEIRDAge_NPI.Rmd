---
title: "SEIRDAge_NPI"
author: "Oscar Dimdore-Miles, Idil Cazimoglu and Liangti Dai"
date: "28/10/2021"
output: rmarkdown::html_vignette
bibliography: references.bib
vignette: >
  %\VignetteIndexEntry{SEIRDAge_NPI}
  %\VignetteEngine{knitr::knitr}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(comomodels)
library(tidyverse)
```


Define helper functions for plotting and contact matrix processing
```{r}
# color by age groups
ggplot_results_by_compartment <- function(output, x="time", y="value", colour="age_range", 
                                          labs_x = "time (days)", labs_y = "fraction of the population", text_size=20){
  output %>%
  ggplot(aes_string(x=x, y=y, colour=colour)) +
  geom_line() +
  #facet_wrap(~compartment) +
  scale_colour_viridis_d() +
  labs(x = labs_x, y = labs_y) +
  theme(text = element_text(size = text_size))  
}

format_matrix <- function(contact_matrix, age_names) {
  colnames(contact_matrix) <- age_names
  contact_matrix$age_infectee <- age_names
  contact_matrix %>%
    pivot_longer(all_of(age_names)) %>% 
    rename(age_infector=name) %>% 
    mutate(age_infector=fct_relevel(age_infector, age_names)) %>% 
    mutate(age_infectee=fct_relevel(age_infectee, age_names))
}

combine_contact_matrices <- function(c_all){
  c_all %>%
    group_by(age_infectee, age_infector) %>% 
    summarise(value=sum(value))
}


combined_contact_matrices_wider <- function(c_combined){
  c_combined %>% 
    pivot_wider(id_cols = age_infectee, names_from = age_infector,
              values_from=value) %>% 
    ungroup() %>% 
    select(-age_infectee) %>% as.matrix()
} 


```

## Introduction

Apart from pharmaceutical interventions such as vaccinations, in order to control the COVID-19 epidemic
at social level[DDDD], a host of **non-pharmaceutical interventions (NPIs)** have been used by governments
around the world. These applications include self-isolation upon testing positive or being in close contact with cases, physical distancing, shielding vulnerable (e.g. elderly) groups, school closure, lockdown, etc. Many of the NPI strategies are applied according to different age groups to adapt to their different social and biological differences, thus including NPIs as an extension to the [SEIRDAge model](https://github.com/Como-DTC-Collaboration/como-models/blob/main/vignettes/SEIRD_age_structured.Rmd) is a key aspect in modelling the epidemiology of COVID-19 transmission, especially on social level [DDDD]. 

In this vignette, we introduce
**an age-structured model including NPI strategies (SEIRDAge_NPI)** and demonstrate the effect of a number of 
different NPI strategies to examine their effects of interventions.

## The SEIRDAge_NPI Model
Consistent with the [SEIRDAge model](https://github.com/Como-DTC-Collaboration/como-models/blob/main/vignettes/SEIRD_age_structured.Rmd), in the `SEIRDAge_NPI` model we decribes how populations of susceptible, exposed, infectious, recovered and dead individuals evolve over time, with taking into account of the intermixing between age groups via social contact matrices $C$, where the elements $C_{ij}$ indicate the expected number of contacts an individual of age class $i$ experiences with age class $j$ per day. In this package we use country-level estimates of contact matrices and visualise for India as an example for the four types of contact matrices: home, work, school and all other types:

```{r, fig.width=8, fig.height=6}
# reformat matrices for plotting
ages <- seq(0, 80, 5)
age_names <- vector(length = 16)
for(i in seq_along(age_names)) {
  age_names[i] <- paste0(ages[i], "-", ages[i + 1])
}


c_home <- format_matrix(contact_home$India, age_names) %>% mutate(type="home")
c_work <- format_matrix(contact_work$India, age_names) %>% mutate(type="work")
c_school <- format_matrix(contact_school$India, age_names) %>% mutate(type="school")
c_other <- format_matrix(contact_other$India, age_names) %>% mutate(type="other")

c_all <- c_home %>%
  bind_rows(c_work) %>% 
  bind_rows(c_school) %>% 
  bind_rows(c_other)

# plot all
c_all %>%
  ggplot(aes(x=age_infector, y=age_infectee, fill=value)) +
  geom_tile() +
  scale_fill_viridis_c() +
  facet_wrap(~type)
```

We can see that the majority of contacts fall between younger individuals, occurring at home or "other" locations. At home, however, there is more substantial intergenerational mixing than in other settings.

We make an overall contact matrix by summming contributions from social settings together.
```{r, fig.width=8, fig.height=5}
c_combined <- combine_contact_matrices(c_all)

c_combined %>% 
  ggplot(aes(x=age_infector, y=age_infectee, fill=value)) +
  geom_tile() +
  scale_fill_viridis_c()


```
We now use this contact matrix to allow infections to pass between age groups, which gives us the
full ODE system of the `SEIRDAge_NPI` model:


The `SEIRDAge_NPI` model consists of five ODEs describing five populations of susceptible,
recovered, infectious, recovered and dead individuals. Susceptible
individuals ($S$) have not been exposed to the virus. Exposed individuals ($E$) have been
exposed to the virus and have been infected but are not yet infectious to others; they are 
in the incubation period. Infectious individuals ($I$) can spread the virus to 
others. Recovered individuals ($R$) are no longer
infectious, and no waning immunity is taken into accound. Any NPI strategy can be appied to multiple, 
non-overlapping time periods. Within each intervention period, we allow fully customised setting of
its corresponding **contact matrices** and the **transmisson parameter $\beta$**. 
Births and deaths unrelated to the infection are not considered in
this model. 

The ODEs describing how the five populations evolve over time are:

$$\frac{\text{d}S_i}{\text{d}t} = -\beta_i(t) S_i \Sigma_{j}C_{ij}(t) I_j,$$
$$\frac{\text{d}E_i}{\text{d}t} = \beta_i(t) S_i \Sigma_{j}C{ij}(t) I_j-\kappa E_i,$$
$$\frac{\text{d}I_i}{\text{d}t} = \kappa E_i - (\gamma_i + \mu_i) I_i,$$
$$\frac{\text{d}R_i}{\text{d}t} = \gamma_i I_i,$$

where $i$ and $j$ represents an age class, and $t$ represents a time point. 
Details of several transmission parameters are:

* $\beta$, $\kappa$, $\gamma_i$, $\mu_i$, $\nu$ are
positive parameters. 

  * $\beta_i(t)$ - The rate at which susceptible individuals are infected
depends on the fraction of the population that is susceptible, the fraction of
the population that is infectious, and the odds of an infectious individual
infecting a susceptible individual. This is represented in the
first terms on the right-hand side of $\text{d}S/ \text{d}t$ and $\text{d}E/ \text{d}t$. 
In this model, we consider $\beta$ to be time and age dependent, because the type and 
time interval of each intervention can be different, and interventions can be applied 
differently onto each age group. 

  * $\kappa$ - The incubation time of the virus is $1/ \kappa$, i.e. how many days 
after exposure the individual becomes infectious to others, thus exposed individuals 
become infectious at rate $\kappa$. Infectious individuals can either recover or die
because of the disease. 

  * $\gamma_i$ - Infectious individuals recover in $1/ \gamma_i$
days, thus individuals recover at rate $\gamma_i$.  In this model we consider different
recovery rate for each age group, as different age groups require different time to recover.


  * $\mu_i$ - Infectious individuals die due to the infection after $1/ \mu_i$ days. In this model
we consider different mortality rate for each age group, as different age groups
exhibit different vulnerability to the infection.



In addition to these five main ODEs, the model also keeps track of the cumulative number 
of cases ($C$) and the cumulative number of disease-related deaths ($D$) over time
$$\frac{\text{d}C_i}{\text{d}t} = \beta(t) S_i \Sigma_{j}C_{ij}(t) I_j,$$
$$\frac{\text{d}D_i}{\text{d}t} = \mu_i I_i.$$

The system is closed by specifying the initial conditions
$$S(0) = S_0,\ E(0) = E_0,\ I(0) = I_0,\ R(0) = R_0, \ C(0) = 0,\ D(0) = 0.$$
In the implementation of the model in this package, the variables are normalized so 
$S(t) + E(t) + I(t) + R(t) + D(t) \equiv 1$ for any given $t$. This means that each of these state variables represents the fraction of the population in each of these states at a given point in time.

The calculation of the basic reproduction number follows the same next-generation matrix approach as in the [SEIRDAge model](https://github.com/Como-DTC-Collaboration/como-models/blob/main/vignettes/SEIRD_age_structured.Rmd).

In this model, interventions of transmission dynamic take on effects through modifying 
the age and time-dependent variables, the contact matrices $C_{ij}(t)$ and transmission parameters$\beta_i(t)$.
Different types of NPI may modify either and/or both variables. We adopt the the specific values
according to "Table 1" in @DaviesNicholasG2020Eoni, in which **shielding the elderly** reduces the contact rates that involve elder age classes in "work" and "other" contacts; **school closures** removes the contacts at "school" for all age groups, affecting primarily on younger age classes; **self-isolation of the infected groups** reduces the transmission rate for any age group; and **lockdown**, being the most stringent
NPI, reduces the contact rates in "work", "school" as well as the transmission rate for all age groups. The implementation of the model allows fully-customised modifications on $C_{ij}(t)$ and $\beta_{i}{t}$ for each
age class and time point.

We next illustrate how this model works using functionality available in `comomodels` through several simulation processes. 



## Simulation examples

We first load the dountry-level demographics from UN and set the number of age classes to be the same in the contact matrices, which is 16 in this instance.

```{r}
load(file = "../data/population.rda")
# use demographic data to create normalised population fractions
pops = population[population$country == 'India', ]$pop
pop_fraction = pops/sum(pops)
## the contact matrix has an upper group of 80+, so we sum the remaining fractions beyond this point
pop_fraction[16] = sum(pop_fraction[16:21])
pop_fraction = pop_fraction[1:16]
# reshape contact matrix into 16x16 form
c_combined_wider <- combined_contact_matrices_wider(c_combined)
# setting up the number of age classes
n_ages <- 16
```


In model initiance, the parameters `n_ages` and `n_npi` represent the number of age classes and the number of NPI intervals, respectively; `contact_matrix` is a single matrix that represents the original contact matrix when no intervention is applied, whereas `contact_matrix_npi` defines
a list of matrices corresponding to the contact matrices of each intervention period. The last parameter `age_ranges`
gives the names for each age group.

Here we demonstrate a simple scenario: a single intervention period that introduces a reduced rate in the connections between all age classes and a reduced infectious transmission rate:

```{r}
# create model
n_npi = 1 # only one intervention
model <- SEIRDAge_NPI(n_age_categories = n_ages,
                      n_npi = n_npi,
                      contact_matrix = c_combined_wider,
                      contact_matrix_npi = list(c_combined_wider*0.5),
                      age_ranges = as.list(age_names)
                      )
```

We now need to set the initial conditions for the model, which defines the initial fraction of each population group
before the simulation starts. Here we assume a uniform initial infected population of 0.1% across all age groups. The remaining 99.9% of the population starts as susceptibles. 
```{r}
initial_conditions(model) <- list(S0=pop_fraction*0.999,
                                  E0=rep(0, n_ages),
                                  I0=pop_fraction*0.001,
                                  R0=rep(0, n_ages),
                                  D0=rep(0, n_ages)
                                 )
```


The initial conditions must sum to one. If they do not, an error will be is thrown.

Next, we need to set the transmission parameter values $\beta$, $\kappa$, $\gamma$ and $\mu$. 

To set age-dependent values for $\gamma$ and $\mu$, we adopted the age-dependent Case Fatality Ratio (CFR, the fraction of infectious individuals who die) according to [@verity2020estimates], as CFR is only dependent on $\gamma$ and $\mu$:

$$ \text{CFR}_i = \frac{\text{rate of death of age class }i}{\text{rate of death of age class }i + \text{rate of recovery of age class }i} = \frac{\mu_i}{\mu_i + \gamma_i} $$

We assume an average latency period ($1/\kappa$) of 5.5 days (as has been estimated for COVID-19; @xin2021estimating) and an average duration of infectiousness ($1/\eta$) of 2 days (which indicates that, after 10 days, $<1\%$ would be infectious, which is in line with UK policy which assumes individuals cannot pass on infection after 10 days; @stayathome2021). For simplicity, we assume that symptom onset occurs at the time an individual becomes infectious (although evidence suggests there is presymptomatic transmission; @stayathome2021).

We assume the following parameterisation: 

$$
\eta = 1/{\text{av. time until noninfectious}}=1/2 \\
\gamma_i = \eta (1-\text{CFR}_i) \\
\mu_i = \eta \text{CFR}_i.
$$

At this point, $\kappa$ is defined; $\gamma_i$ and $\mu_i$ can be derived; $\beta_i(t)$ needs to be set. In the setter function `transmission_parameters` for `SEIRDAge_NPI`, the parameter `beta` defines the transmission rate for each age group
when no invervention is applied; whereas `beta_npi` defines a list of age-dependent transmission rates that
corresponds to each inverntion period, or a single vector or a value if there's only a single invervention period. Consistent with the examples presented in `SEIRDAge` class, here we choose a value for $\beta$ to be the same
across all age groups to result in the same $R_0$ value ($R_0=2.4$) as reported in "Report 9" by Imperial College London (Ferguson et al. 2020), and we set `beta_npi` to be $0.65\beta$ for all age groups.

```{r}

# CFR for each age group
# (for 80+ group we pick upper age to be 110)
df <- tribble(
  ~lower_age, ~upper_age, ~cfr,
  0, 9, 0.00260,
  10, 19, 0.0148,
  20, 29, 0.0600,
  30, 39, 0.146,
  40, 49, 0.295,
  50, 59, 1.25,
  60, 69, 3.99,
  70, 79, 8.61,
  80, 110, 13.4) %>% 
  mutate(cfr = cfr / 100) %>% 
  mutate(age_range=paste0(lower_age, "-", upper_age)) %>% 
  mutate(age_range=as.factor(age_range)) %>% 
  mutate(age_range=fct_reorder(age_range, lower_age))

# setting up kappa, eta, beta
kappa <- 1 / 5.5
eta <- 1 / 2
beta <- 0.707

# assume cfr constant within age ranges of contact matrix bands
get_lower_age <- function(x) {
  as.numeric(substr(x, 1, regexpr("-", x) - 1))
}
get_upper_age <- function(x) {
  as.numeric(substr(x, regexpr("-", x) + 1, nchar(x)))
}
lower_age <- map_dbl(age_names, get_lower_age)
upper_age <- map_dbl(age_names, get_upper_age)
middle_age <- (lower_age + upper_age) / 2

# assume CFR is constant within age hands
cfr_vals <- vector(length = length(middle_age))
cfr_getter <- function(age, df) {
  for(j in 1:nrow(df)) {
    if(age > df$lower_age[j] & age <= df$upper_age[j])
      return(df$cfr[j])
  }
}
cfr_vals <- map_dbl(middle_age, ~cfr_getter(., df))

# defive age-dependent gamma and mu
gamma_vals <- eta * (1 - cfr_vals)
mu_vals <- eta * cfr_vals

# setting up transmission parameters
params <- list(beta_npi = 0.65*beta, beta = beta,
               kappa = kappa, gamma = gamma_vals, mu = mu_vals)
transmission_parameters(model) <- params
```

To check that the parameters have been set correctly, we call
```{r}
transmission_parameters(model)
```

We can check if the basic reproduction number is as we expected:
```{r}
print(paste0("R_0 = ", round(R0(model), 2)))
```



Now we simulate the system from $t=0$ days to $t=250$ days, with a single intervention between $t=20$ and $t=40$.
```{r}
interven <- list(list("starts"=20, "stops"=40, "coverages"=1))

interventions(model) <- interven
times <- seq(0, 250, by = 1)
out_df <- run(model, times)
```


Let us plot the population size for each epidemiological group and each age group.
```{r, fig.width=10, fig.height=5}
states = out_df$states
states %>% ggplot_results_by_compartment() +
  facet_wrap(~compartment)
```

We see that the intervention prevents the epidemic peak at the start. As the intervention stops, the epidemic re-started.


Zooming in on the infected population, we see that the younger age groups have the highest peak infected population levels.
```{r, fig.width=8, fig.height=5}
states %>%
  filter(compartment=="I") %>% 
  ggplot_results_by_compartment() +
  facet_wrap(~compartment)
```


The simulation also outputs incidence and deaths. These are derived from the state variables. Incidence is just the difference between the cumulative number of cases between two time points,

$$ \text{incidence(t)} = C(t) - C(t - 1),$$

since this shows the number of cases which have arisen between these time  points. Deaths are also given by a difference, but, in this instance, between the cumulative number of deaths at two consecutive time points:

$$ \text{deaths(t)} = D(t) - D(t - 1).$$

```{r fig2, fig.height = 5, fig.width = 7}
changes <- out_df$changes
changes %>%
  filter(compartment=="Incidence") %>% 
  ggplot_results_by_compartment(labs_y = "fraction of the population \n that is newly infected per day")
changes %>%
  filter(compartment=="Deaths") %>% 
  ggplot_results_by_compartment(labs_y = "fraction of the population \n that died per day")

```


## Sensitivity analysis


Different non-pharmaceutical interventions introduce different changes 
in contact rates and infectiousness of the infected individuals. 
In the model, the differences present on the values of contact matrices 
and $beta_npi$. We now explore several NPI scenarios: **physical distancing (*PD*)**, **self-isolation of the infected groups (*SI*)**, **school closures (*SC*)**, **shielding of older age groups (*SO*)**, and a combination of them (**lockdown**). 

For the parameters of each scenario, we adopt the settings from [Davies, et.al. (2020)](https://doi.org/10.1016/S2468-2667(20)30133-X).

We introduce the intervention into the outbreak period of the epidemic.


### The effects of different NPIs

We first examine the effects of different NPI strategies applied on the same single intervention period:

```{r, fig.height = 5, fig.width = 15}
run_SEIRDAge_NPI_single_intv <- function(beta_npi_frac, contact_matrix_npi) {
  inits <- list(S0=pop_fraction*0.999,
                E0=rep(0, n_ages),
                I0=pop_fraction*0.001,
                R0=rep(0, n_ages),
                D0=rep(0, n_ages)
                )
  kappa <- 1 / 5.5
  eta <- 1 / 2
  beta <- 0.707
  cfr_vals <- map_dbl(middle_age, ~cfr_getter(., df))
  gamma_vals <- eta * (1 - cfr_vals)
  mu_vals <- eta * cfr_vals
  
  params <- list(beta_npi = beta_npi_frac * beta, beta = beta,
               kappa = kappa, gamma = gamma_vals, mu = mu_vals)
  
  model <- SEIRDAge_NPI(
    n_age_categories = n_ages,
    n_npi = 1,
    contact_matrix = c_combined_wider,
    contact_matrix_npi = contact_matrix_npi,
    age_ranges = as.list(age_names),
    initial_conditions = inits,
    transmission_parameters=params,
    interventions = list(list("starts"=20, "stops"=60, "coverages"=1)))
  times <- seq(0, 250, by = 1)
  out_df <- run(model, times)
  out_df
}



# run model for different scenarios
## basline (baseline: no intervention at all)
model_base <- run_SEIRDAge_NPI_single_intv(1, list(c_combined_wider))
result <- model_base$changes %>% mutate(scenario="baseline")
result_states <- model_base$states %>% mutate(scenario="baseline")

## physical distancing: work and other contact values become 50% of baseline
c_work_pd <- c_work
c_work_pd$value <- c_work$value * 0.5
c_other_pd <- c_other
c_other_pd$value <- c_other$value * 0.5

c_combined_wider_pd <- c_home %>%
  bind_rows(c_work_pd) %>% 
  bind_rows(c_school) %>% 
  bind_rows(c_other_pd) %>% 
  combine_contact_matrices() %>% 
  combined_contact_matrices_wider()

model_pd <- run_SEIRDAge_NPI_single_intv(1, list(c_combined_wider_pd))
result <- result %>% bind_rows(model_pd$changes %>% mutate(scenario="physical distancing (PD)"))
result_states <- result_states %>% bind_rows(model_pd$states %>% mutate(scenario="physical distancing (PD)"))

## self-isolation of the infected groups: beta_intervention = beta * 0.65
model_si <- run_SEIRDAge_NPI_single_intv(0.65, list(c_combined_wider))
result <- result %>% bind_rows(model_si$changes %>% mutate(scenario="self-isolation"))
result_states <- result_states %>% bind_rows(model_si$states %>% mutate(scenario="self-isolation (SI)"))

## school closures: no school contacts
c_combined_wider_sc <- c_home %>%
  bind_rows(c_work) %>% 
  #bind_rows(c_school*0) %>% 
  bind_rows(c_other) %>% 
  combine_contact_matrices() %>% 
  combined_contact_matrices_wider()

model_sc <- run_SEIRDAge_NPI_single_intv(1, list(c_combined_wider_sc))
result <- result %>% bind_rows(model_sc$changes %>% mutate(scenario="school closure (SC)"))
result_states <- result_states %>% bind_rows(model_sc$states %>% mutate(scenario="school closure (SC)"))

## shielding of older population groups: in work contacts and other contacts, the contact rates of >old yrs (either contactor or contactee) become 25% of baseline. 
## ??? would >70 - >70 contact rate be further reduced?
age_old = 65
age_old_work <- (lapply(c_work$age_infector %>% as.character(), function(age) as.integer(strsplit(age, "-")[[1]][1]) >= age_old) %>% unlist) | (lapply(c_work$age_infectee %>% as.character(), function(age) as.integer(strsplit(age, "-")[[1]][1]) >= age_old) %>% unlist)
age_old_other <- (lapply(c_other$age_infector %>% as.character(), function(age) as.integer(strsplit(age, "-")[[1]][1]) >= age_old) %>% unlist) | (lapply(c_other$age_infectee %>% as.character(), function(age) as.integer(strsplit(age, "-")[[1]][1]) >= age_old) %>% unlist)

c_work_so = c_work
c_work_so[age_old_work, "value"] = c_work[age_old_work, "value"]*0.25

c_other_so = c_other
c_other_so[age_old_other, "value"] = c_work[age_old_other, "value"]*0.25

c_combined_wider_so <- c_home %>%
  bind_rows(c_work_so) %>% 
  bind_rows(c_school) %>% 
  bind_rows(c_other_so) %>% 
  combine_contact_matrices() %>% 
  combined_contact_matrices_wider()
model_so <- run_SEIRDAge_NPI_single_intv(1, list(c_combined_wider_so))
result <- result %>% bind_rows(model_so$changes %>% mutate(scenario="shielding of older (SO)"))
result_states <- result_states %>% bind_rows(model_so$states %>% mutate(scenario="shielding of older (SO)"))

## lockdown: work, other, school -> 10%, beta -> 0.65
c_work_l <- c_work
c_work_l$value <- c_work$value * 0.1
c_school_l <- c_school
c_school_l$value <- c_school$value * 0.1
c_other_l <- c_other
c_other_l$value <- c_other$value * 0.1

c_combined_wider_l <- c_home %>%
  bind_rows(c_work_l) %>% 
  bind_rows(c_school_l) %>% 
  bind_rows(c_other_l) %>% 
  combine_contact_matrices() %>% 
  combined_contact_matrices_wider()
model_l <- run_SEIRDAge_NPI_single_intv(0.65, list(c_combined_wider_l))
result <- result %>% bind_rows(model_l$changes %>% mutate(scenario="lockdown"))
result_states <- result_states %>% bind_rows(model_l$states %>% mutate(scenario="lockdown"))


# add intervention intervals
starts = 20
stops = 50

result[result$scenario!="baseline", "interv_starts"] <- starts
result[result$scenario!="baseline", "interv_stops"] <- stops
result_states[result_states$scenario!="baseline", "interv_starts"] <- starts
result_states[result_states$scenario!="baseline", "interv_stops"] <- stops


# plot results
result_states %>% 
  filter(compartment=="S" | compartment=="R") %>% 
  ggplot_results_by_compartment(text_size = 15) + 
  facet_grid(compartment ~ scenario) +
  geom_rect(aes_string(xmin = "interv_starts", xmax = "interv_stops", ymin = -Inf, ymax = Inf),
             colour="red", fill=NA)

result_states %>% 
  filter(compartment=="I" | compartment=="E") %>% 
  ggplot_results_by_compartment(text_size = 15) + 
  facet_grid(compartment ~ scenario) +
  geom_rect(aes_string(xmin = "interv_starts", xmax = "interv_stops", ymin = -Inf, ymax = Inf),
             colour="red", fill=NA)

result %>% 
  filter(compartment=="Deaths") %>%
  ggplot_results_by_compartment(labs_y="fraction of the population \n that died per day", text_size = 15) +
  facet_wrap(~scenario) +
  geom_rect(aes_string(xmin = "interv_starts", xmax = "interv_stops", ymin = -Inf, ymax = Inf),
             colour="red", fill=NA)

result %>% 
  filter(compartment=="Incidence") %>% 
  ggplot_results_by_compartment(labs_y="fraction of the population \n that is newly infected per day", text_size = 15) +
  facet_wrap(~scenario) +
  geom_rect(aes_string(xmin = "interv_starts", xmax = "interv_stops", ymin = -Inf, ymax = Inf),
             colour="red", fill=NA)


```

We can observe different interference results between the five NPI scenarios. 
Apart from *SO* where the effects are 
mostly restricted to the reduced deaths within the older age group,
all other interventions present the decreased rate of transmission, reduced 
number of infected cases and reduced deaths across all age groups. Looking at the change of the 
fraction of the population that is newly infected over time (Incidence), *PD*, *SC* and *SI* and *lockdown*
result in the decrease of the increasing rate of Incidence as soon as the intervention begeins, reaching lower peak values later on. In addition, *lockdown* controls the outbreak rapidly and thouroughly within the invervention period, but as the intervention lifts, the ungoing epidemic still arouses a second outbreak, though milder compared with the baseline. All strategies except *SO* extends the overall duration of the pandemic from 100 simulation
time points in the baseline to around 150. All these suggest that even a short but stringent NPI, 
such as lockdown, can still alleviate and defer an significant outbreak. Although NPI applications may take effects at a cost of extended pandemic duration once the intervention lifts, they can act as fast social-control measures that open a valuable time window for human beings to develop specific clinical and pharmaceutical methods as well as more comprehensive and long-term strategies when facing an unexpected
infectious disease.



### The effects of different ordering of NPIs
We further explore the combinations of different NPI scenarios by focusing on the effect of different ordering of two NPIs, self-isolation (SO) and physical distancing (PD).
```{r, fig.height=5, fig.width=15}
run_SEIRDAge_NPI_mult_intv <- function(beta_npi_frac, contact_matrix_npi, n_npi) {
  inits <- list(S0=pop_fraction*0.999,
                E0=rep(0, n_ages),
                I0=pop_fraction*0.001,
                R0=rep(0, n_ages),
                D0=rep(0, n_ages)
                )
  kappa <- 1 / 5.5
  eta <- 1 / 2
  beta <- 0.707
  cfr_vals <- map_dbl(middle_age, ~cfr_getter(., df))
  gamma_vals <- eta * (1 - cfr_vals)
  mu_vals <- eta * cfr_vals
  params <- list(beta_npi = beta_npi_frac*beta, beta = beta,
               kappa = kappa, gamma = gamma_vals, mu = mu_vals)
  model <- SEIRDAge_NPI(
    n_age_categories = n_ages,
    n_npi = n_npi,
    contact_matrix = c_combined_wider,
    contact_matrix_npi = contact_matrix_npi,
    age_ranges = as.list(age_names),
    initial_conditions = inits,
    transmission_parameters=params,
    interventions = list(list("starts"=3, "stops"=20, "coverages"=1),
                         list("starts"=40, "stops"=50, "coverages"=1)))
  times <- seq(0, 250, by = 1)
  out_df <- run(model, times)
  out_df
}

starts = c(3, 40)
stops = c(20, 50)

# run model for different scenarios
## basline (baseline: no intervention at all)
result <- model_base$changes %>% mutate(scenario="baseline")
result_states <- model_base$states %>% mutate(scenario="baseline")


model_pd_pd <- run_SEIRDAge_NPI_mult_intv(c(1, 1), list(c_combined_wider_pd, c_combined_wider_pd), 2)
result <- result %>% bind_rows(model_pd_pd$changes %>% mutate(scenario="PD-PD"))
result_states <- result_states %>% bind_rows(model_pd_pd$states %>% mutate(scenario="PD-PD"))

## self-isolation of the infected groups: beta_intervention = beta * 0.65
model_si_si <- run_SEIRDAge_NPI_mult_intv(c(0.65, 0.65), list(c_combined_wider, c_combined_wider), 2)
result <- result %>% bind_rows(model_si_si$changes %>% mutate(scenario="SI-SI"))
result_states <- result_states %>% bind_rows(model_si_si$states %>% mutate(scenario="SI-SI"))

model_pd_si <- run_SEIRDAge_NPI_mult_intv(c(1, 0.65), list(c_combined_wider_pd, c_combined_wider), 2)
result <- result %>% bind_rows(model_pd_si$changes %>% mutate(scenario="PD-SI"))
result_states <- result_states %>% bind_rows(model_pd_si$states %>% mutate(scenario="PD-SI"))

model_si_pd <- run_SEIRDAge_NPI_mult_intv(c(0.65, 1), list(c_combined_wider, c_combined_wider_pd), 2)
result <- result %>% bind_rows(model_si_pd$changes %>% mutate(scenario="SI-PD"))
result_states <- result_states %>% bind_rows(model_si_pd$states %>% mutate(scenario="SI-PD"))



# add intervention intervals
result[result$scenario!="baseline", "interv_starts"] <- starts
result[result$scenario!="baseline", "interv_stops"] <- stops
result_states[result_states$scenario!="baseline", "interv_starts"] <- starts
result_states[result_states$scenario!="baseline", "interv_stops"] <- stops


# plot results
result_states %>% 
  filter(compartment=="S" | compartment=="R") %>% 
  ggplot_results_by_compartment(text_size = 15) +
  geom_rect(aes_string(xmin = "interv_starts", xmax = "interv_stops", ymin = -Inf, ymax = Inf),
             colour="red", fill=NA) +
  facet_grid(compartment ~ scenario)

result_states %>% 
  filter(compartment=="I" | compartment=="E") %>% 
  ggplot_results_by_compartment(text_size = 15) +
  geom_rect(aes_string(xmin = "interv_starts", xmax = "interv_stops", ymin = -Inf, ymax = Inf),
             colour="red", fill=NA) + 
  facet_grid(compartment ~ scenario)

result %>% 
  filter(compartment=="Deaths") %>%
  ggplot_results_by_compartment(labs_y="fraction of the population \n that died per day", text_size = 15) +
  geom_rect(aes_string(xmin = "interv_starts", xmax = "interv_stops", ymin = -Inf, ymax = Inf),
             colour="red", fill=NA) +
  facet_wrap(~scenario)

result %>% 
  filter(compartment=="Incidence") %>% 
  ggplot_results_by_compartment(labs_y="fraction of the population \n that is newly infected per day", text_size = 15) +
  geom_rect(aes_string(xmin = "interv_starts", xmax = "interv_stops", ymin = -Inf, ymax = Inf),
             colour="red", fill=NA) +
  facet_wrap(~scenario)

```

We can see different order of combined NPIs result in different intervention senarios. (ADD MORE)


## References

