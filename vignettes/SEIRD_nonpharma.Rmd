---
title: "The SEIRD model with isolating infected population"
author: "Idil Cazimoglu"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{SEIRD model with isolating infected population}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
--- 

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(comomodels)
library(ggplot2)
library(glue)
library(dplyr)
library(deSolve)
library(reshape2)
```

## Introduction
This document explains SEIRD model with isolating infected population. The infected population is split into two 
compartments: not isolating (I) and isolating (I_isolated). A simple ordinary differential equation (ODE) is defined for each of the populations.

## The SEIRD Model with isolating and not isolating infected populations
This model consists of five ODEs describing populations of susceptible,
recovered, isolating infectious, not isolating infectious, and recovered individuals.

The ODEs describing how the five populations evolve over time are
$$\frac{\text{d}S}{\text{d}t} = -\beta S I -\beta_i S I_i,$$
$$\frac{\text{d}E}{\text{d}t} = \beta S I + \beta_i S I_i -\kappa E,$$

$$\frac{\text{d}I}{\text{d}t} = (1 - \eta)  \kappa E - (\gamma + \mu) I,$$
$$\frac{\text{d}I_i}{\text{d}t} = \eta\kappa E - (\gamma + \mu) I_i,$$

$$\frac{\text{d}R}{\text{d}t} = \gamma I + \gamma  I_i,$$
where $\beta$, $\beta_i$, $\kappa$, $\gamma$, $\mu$ and $\eta$ are positive parameters.
The rate at which susceptible individuals are infected depends on the fraction
of the population that is susceptible, the fraction of the population that is
infectious and not isolating and the probability of such an individual infecting a
susceptible individual, $\beta$, and the fraction of the population that is
infectious and isolating and the probability of such an individual infecting a
susceptible individual, $\beta_i$.These are represented in the first two terms on the right-hand side of
$\text{d}S/ \text{d}t$ and $\text{d}E/ \text{d}t$.

Exposed individuals become infectious at rate $\kappa$. $1/ \kappa$ is
the incubation time of the virus, i.e. how many days after exposure the individual
becomes infectious to others. Infectious individuals can either recover or die
because of the disease. Infectious individuals recover in $1/ \gamma$
days, thus individuals recover at rate $\gamma$. Similarly, infectious
individuals die due to the infection after $1/ \mu$ days, making the death rate $\mu$.

In addition to these five main ODEs, the model also keeps track of the cumulative number 
of cases ($C$) and the cumulative number of disease-related deaths ($D$) over time
$$\frac{\text{d}C}{\text{d}t} = \beta S I + \beta_i S I_i,$$
$$\frac{\text{d}D}{\text{d}t} = \mu I + \mu I_i.$$

The system is closed by specifying the initial conditions
$$S(0) = S_0,\ E(0) = E_0,\ I(0) = I_0,\ I(0) = I_i0,\ R(0) = R_0,\ C(0) = C_0,\ D(0) = D_0,$$
In the implementation of the model in this package, the variables are normalized so 
$S(t) + E(t) + I(t) +I_i(t) + R(t) + D(t) \equiv 1$ for any given $t$. This means that each of these state variables represents the fraction of the population in each of these states at a given point in time.


We next illustrate how this model works using functionality available in `comomodels`.

## The `SEIRD` class

We first create an `SEIRD` object that we will use to run simulations.
```{r}
my_model <- SEIRD_nonpharma()
```

Next, we set the parameter values for $\beta$, $\kappa$, $\gamma$, $\mu$ and $\eta$:
```{r}
params <- list(beta=0.5, beta_isolated=0.1, kappa=0.2, gamma=0.1, mu=0.048, heta1=0.9, heta2=0.05)
transmission_parameters(my_model) <- params
```

To check that the parameters have been set correctly, we call
```{r}
transmission_parameters(my_model)
```

We now need to set the initial conditions for the model. We only set the initial conditions $S(0)$, $E(0)$, $I(0)$ and $R(0)$.
```{r}
initial_conditions(my_model) <- list(S0=0.999, E0=0, I0=0.001, I0_isolated=0, R0=0)
```
The initial conditions must sum to one. If they do not, an error is thrown.

Now we simulate the system from $t=0$ days to $t=90$ days.
```{r}
times <- seq(0, 90, by = 1)
t_intervention_1_2 <- 10
t_intervention_2_3 <- 70
out_df <- run(my_model, times, t_intervention_1_2, t_intervention_2_3)
```

Optional graph of I and I_isolated over time:
```{r, fig.height = 2, fig.width = 6}
I_compartments <- out_df$I_compartments

ggplot(I_compartments, aes(x = time, y = value)) +
  geom_line(aes(color = compartment)) +
  scale_color_brewer(palette = "Dark2") +
  labs(x = "time (days)", y = "fraction of the population",
       title = glue("Evolution of various compartments over time"))
```




The simulation returns two objects: one is a data frame comprising the states over time.
```{r, fig.height = 5, fig.width = 7}
states <- out_df$states

ggplot(states, aes(x = time, y = value)) +
  geom_line(aes(color = compartment)) +
  scale_color_brewer(palette = "Dark2") +
  labs(x = "time (days)", y = "fraction of the population",
       title = glue("Evolution of various compartments over time"))
```

The simulation also outputs incidence and deaths. These are derived from the state variables. Incidence is just the difference between the cumulative number of cases between two time points,

$$ \text{incidence(t)} = C(t) - C(t - 1),$$

since this shows the number of cases which have arisen between these time points. Deaths are also given by a difference, but, in this instance, between the cumulative number of deaths at two consecutive time points:

$$ \text{deaths(t)} = D(t) - D(t - 1).$$

```{r fig2, fig.height = 5, fig.width = 7}
changes <- out_df$changes

ggplot(changes, aes(x = time, y = value, fill = compartment)) +
  geom_bar(stat="identity", position = position_dodge()) +
  labs(x = "time (days)", y = "fraction of the population per day",
       title = glue("Incidences and deaths")) +
  theme(legend.position = "bottom", legend.title = element_blank())

```

## Sensitivity analysis
In this section, we investigate the sensitivity of the number of deaths to the isolation rate, $\eta$. We run the model for varying values of $\eta$ and plot the number of deaths per day over time.
```{r, fig.height = 5, fig.width = 7}
# function to setup and run model for different beta values
run_seird <- function(heta_val) {
  inits <- list(S0=0.99, E0=0, I0=0.01, I0_isolated=0, R0=0)
  params <- list(beta=0.5, beta_isolated=0.1, kappa=0.9, gamma=0.5, mu=0.1, heta1=heta_val, heta2=heta_val)
  model <- SEIRD_nonpharma(initial_conditions = inits,
                transmission_parameters=params)
  #times <- seq(31800, 31900, by = 1)
  times <- seq(0, 90, by = 1)
  out_df <- run(model, times)
  out_df$changes
}

# run model across different heta2 values
heta_vals <- c(0, 0.25, 0.5, 0.75, 1)
for(i in seq_along(heta_vals)) {
  heta_temp <- heta_vals[i]
  temp <- run_seird(heta_temp) %>% mutate(heta1=heta_temp)
  if(i == 1)
    result <- temp %>% mutate(heta1=heta_temp)
  else
    result <- result %>% bind_rows(temp)
}

# plot results
result %>% 
  filter(compartment=="Deaths") %>% 
  ggplot(aes(x=time, y=value, fill = as.factor(heta1))) +
  geom_bar(stat = "identity", position = position_dodge()) +
  labs(x = "time (days)", y = "Fraction of the population that died per day",
       title = glue("Number of deaths for differing values of eta")) + 
  scale_fill_discrete(labels = c("None", "1/4", "1/2","3/4","All"))+
  theme(legend.position = "bottom", legend.title = element_blank()) + xlim(t_intervention_1_2, t_intervention_2_3)


```

How does isolation of infected population affect the basic reproductive number, $R_0$, which is the expected number of people infected by a
single infectious individual in a population where everyone is susceptible (i.e $S_0 \approx 1$)? In our model with normalized populations and isolated and not isolated infected compartments, the reproductive number is given by:

$$R_0 = (1-\eta) \beta S_0/(\gamma + \mu) + \eta\beta_i S_0/(\gamma + \mu).$$
We now calculate $R_0$ for $\eta=0$ and $\eta=1$.
```{r, fig.height = 5, fig.width = 7}
inits <- list(S0=0.99, E0=0, I0=0.01, I0_isolated= 0, R0=0)

heta_val <- 0
params <- list(beta=0.5, beta_isolated=0.1, kappa=0.9, gamma=0.5, mu=0.1, heta=heta_val)
model1 <- SEIRD_nonpharma(initial_conditions = inits,
              transmission_parameters=params)

heta_val <- 1
params <- list(beta=0.5, beta_isolated=0.1, kappa=0.9, gamma=0.5, mu=0.1, heta=heta_val)
model2 <- SEIRD_nonpharma(initial_conditions = inits,
              transmission_parameters=params)
paste0("R0(eta=0) = ", R0(model1))
paste0("R0(eta=1) = ", R0(model2))
```

We see that for $R_0$ is smaller for larger $\eta$, so isolation of infected population reduces the transmission rate.