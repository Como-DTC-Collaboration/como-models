---
title: "The SEIRD model"
author: "Hui Jia Farm and Solveig A. van der Vegt"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{The basic SEIR model}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(comomodels)
library(ggplot2)
library(glue)
```

## Introduction
This document explains the basics of the SEIR model. The model describes
how populations of susceptible, exposed, infectious and recovered
individuals evolve over time. A simple
ordinary differential equation (ODE) is defined for each of the populations. In `comomodels`, we provide users with a premade SEIR model and here use it to illustrate how this type of model works.

## The SEIRD Model
The SEIRD model consists of four ODEs describing the four populations. Susceptible
individuals ($S$) have not been exposed to the virus. Exposed individuals ($E$) have been
exposed to the virus and have been infected but are not yet infectious to others; they are 
in the incubation period. Infectious individuals ($I$) can spread the virus to 
others. Recovered individuals ($R$) are no longer
infectious, and, in this model, have acquired immunity as they do not return
to the susceptible population. Births and deaths are not considered in this model.
The ODEs describing how these four populations evolve over time are
$$\frac{\text{d}S}{\text{d}t} = -\beta S I,$$
$$\frac{\text{d}E}{\text{d}t} = \beta S I -\kappa E,$$
$$\frac{\text{d}I}{\text{d}t} = \kappa E - (\gamma + \mu) I,$$
$$\frac{\text{d}R}{\text{d}t} = \gamma I,$$
where $\beta$, $\kappa$, $\gamma$ and $\mu$ are positive parameters.
The rate at which susceptible individuals are infected depends on the fraction
of the population that is susceptible, the fraction of the population that is
infectious, and the probability of an infectious individual infecting a 
susceptible individual, $\beta$. This is represented in the
first terms on the right-hand side of $\text{d}S/ \text{d}t$ and $\text{d}E/ \text{d}t$.
Exposed individuals become infectious at rate $\kappa$. $1/ \kappa$ is
the incubation time of the virus, i.e. how many days after exposure the individual
becomes infectious to others. Infectious individuals can either recover or die
because of the disease. Infectious individuals recover in $1/ \gamma$
days, thus individuals recover at rate $\gamma$. Similarly, infectious
individuals die due to the infection after $1/ \mu$ days, making the death rate $\mu$.

In addition to these four main ODEs, the model also keeps track of the cumulative number 
of cases ($C$) and the cumulative number of disease-related deaths ($D$) over time
$$\frac{\text{d}C}{\text{d}t} = \beta S I,$$
$$\frac{\text{d}D}{\text{d}t} = \mu I.$$

The system is closed by specifying the initial conditions
$$S(0) = S_0,\ E(0) = E_0,\ I(0) = I_0,\ R(0) = R_0,\ C(0) = C_0,\ D(0) = D_0,$$
where $C_0 = E_0 + I_0 + R_0$ to ensure the cases that occur before $t=0$ are
also counted.
In the implementation in this package, the variables are normalized so 
$S(t) + E(t) + I(t) + R(t) + D(t) \equiv 1$ for any given $t$. This means that each of these state variables represents the fraction of the population in each of these states at a given point in time.

Steady states of the system described above are computed by setting the right-hand sides of the ODEs equal to zero. Taking the equation for the susceptibles:

$$\frac{\text{d}S}{\text{d}t} = -\beta S I = 0.$$

This only has solutions if: $S=0$, in which case there are no individuals left to infect; of $I=0$, in which case there are no infectious individuals, and the disease dose not invade the population.

We next illustrate how this model works using functionality available in `comomodels`.

## The `SEIRD` class

We first create an `SEIRD` object that we will use to run simulations.
```{r}
my_model <- SEIRD()
```

Next, we set the parameter values for $\beta$, $\kappa$, $\gamma$ and $\mu$:
```{r}
transmission_parameters(my_model) <- list(beta=1,
                                          kappa=0.9,
                                          gamma=0.5,
                                          mu=0.1)
```

The four values in the list on the right-hand side are assigned to $\beta$, $\kappa$, $\gamma$, and $\mu$, respectively.

To check that the parameters have been set correctly, we call
```{r}
transmission_parameters(my_model)
```

We now need to set the initial conditions for the model. We only set the initial conditions $S(0)$, $E(0)$, $I(0)$ and $R(0)$.
```{r}
initial_conditions(my_model) <- list(S0=0.9, E0=0, I0=0.1, R0=0)
```

The values in the list on the right-hand side are assigned to $S(0)$, $E(0)$, $I(0)$ and $R(0)$, respectively. The initial conditions must sum to one. If they do not, an error is thrown.

Now we simulate the system from $t=0$ days to $t=50$ days.
```{r}
times <- seq(0, 50, by = 0.1)
out_df <- run(my_model, times)
```

Simulation returns two objects: one is a data frame of states over time
```{r}
states <- out_df$states

ggplot(states, aes(x = time, y = value)) +
  geom_line(aes(color = compartment)) +
  scale_color_brewer(palette = "Dark2")
```

Explain how incidence and deaths are computed.
```{r fig2, fig.height = 5, fig.width = 7}
daily <- out_df$daily

ggplot(daily, aes(x = time, y = value)) +
  geom_line(aes(color = compartment)) +
  scale_color_brewer(palette = "Dark2")
```
