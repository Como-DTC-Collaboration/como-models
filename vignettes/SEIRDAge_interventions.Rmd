---
title: "SEIRDAge_interventions"
author: "Oscar Dimdore-Miles and Idil Cazimoglu"
date: "15/07/2021"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{SEIR_age_structured}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(comomodels)
library(tidyverse)
```

## Introduction
A key aspect of modeling the spread of COVID-19 is the implementation of non-pharmaceutical interventions such as self isolating reducing physical contact through social distancing and shielding vulnerable groups. In this vignette, we implement the effect of a number of such interventions and examine their influence virus dynamics using an age structured SEIRD model.

For this vignette we utilise an example case for social contact and subsequent virus dynamics. The contact matrices, $C$ indicate the expected number of contacts an individual of age class $i$ experiences with age class $j$ per day. In this package, we include country-level estimates of contact matrices (Prem et al., 2017; for full details see data documentation). There are actually four types of contact matrix corresponding to daily numbers of contacts at home, work, school and all other settings. Here, we visualise these for India.
```{r, fig.width=10, fig.height=8}
# reformat matrices for plotting
ages <- seq(0, 80, 5)
age_names <- vector(length = 16)
for(i in seq_along(age_names)) {
  age_names[i] <- paste0(ages[i], "-", ages[i + 1])
}

format_matrix <- function(contact_matrix, age_names) {
  colnames(contact_matrix) <- age_names
  contact_matrix$age_infectee <- age_names
  contact_matrix %>%
    pivot_longer(all_of(age_names)) %>% 
    rename(age_infector=name) %>% 
    mutate(age_infector=fct_relevel(age_infector, age_names)) %>% 
    mutate(age_infectee=fct_relevel(age_infectee, age_names))
}


c_home <- format_matrix(contact_home$India, age_names) %>% mutate(type="home")
c_work <- format_matrix(contact_work$India, age_names) %>% mutate(type="work")
c_school <- format_matrix(contact_school$India, age_names) %>% mutate(type="school")
c_other <- format_matrix(contact_other$India, age_names) %>% mutate(type="other")

c_all <- c_home %>%
  bind_rows(c_work) %>% 
  bind_rows(c_school) %>% 
  bind_rows(c_other)

# plot all
c_all %>%
  ggplot(aes(x=age_infector, y=age_infectee, fill=value)) +
  geom_tile() +
  scale_fill_viridis_c() +
  facet_wrap(~type)
```

We can see that the majority of contacts fall between younger individuals, occurring at home or "other" locations. At home, however, there is more substantial intergenerational mixing than in other settings.

We make an overall contact matrix by summming contributions from social settings together.
```{r, fig.width=8, fig.height=5}
c_combined <- c_all %>% 
  group_by(age_infectee, age_infector) %>% 
  summarise(value=sum(value))
c_combined %>% 
  ggplot(aes(x=age_infector, y=age_infectee, fill=value)) +
  geom_tile() +
  scale_fill_viridis_c()
```




## Simulation examples 

Now we create a model that includes this age-structured mixing as well as a proportion of infected individuals self isolating.
Since the contact matrices have 16 age classes, we instantiate a model with this number of age ranges.
We also give it transmission parameters, populate the age classes with initial conditions and provide it with our overall contact matrix.

We use more demographics loaded from the population data file provided by UN and, for this example, initialise the model
with a uniform initial infected population of 1% across all age groups. The remaining 99% of the population starts
as susceptibles. We set the 
```{r}
load(file = "../data/population.rda")

pops = population[population$country == 'India', ]$pop
pop_fraction = pops/sum(pops)
pop_fraction[16] = sum(pop_fraction[16:21])
pop_fraction = pop_fraction[1:16]

n_ages <- 16
c_combined_wider <- c_combined %>% 
  pivot_wider(id_cols = age_infectee, names_from = age_infector,
              values_from=value) %>% 
  ungroup() %>% 
  select(-age_infectee) %>% 
  as.matrix()
model <- comomodels::SEIRDAge_interventions(n_age_categories = n_ages,
                 contact_matrix_1 = c_combined_wider, 
                 contact_matrix_2 = c_combined_wider, 
                 contact_matrix_3 = c_combined_wider, age_ranges = as.list(age_names))

transmission_parameters(model) <- list(beta = 1, kappa=0.5, gamma=0.5, 
                                 mu = 0.01)

initial_conditions(model) <- list(S0=pop_fraction*0.99,
                                  E0=rep(0, n_ages),
                                  I0=pop_fraction*0.01,
                                  R0=rep(0, n_ages),
                                  D0=rep(0, n_ages))
```

We next simulate the model and visualise all the dynamics of each compartment.
```{r, fig.width=10, fig.height=5}
res <- run(model, time=seq(0, 50, by = 0.1), t_intervention_1_2 = 20,
           t_intervention_2_3 = 40)$states
res %>%
  filter(compartment!="Incidence") %>% 
  ggplot(aes(x=time, y=value, colour=age_range)) +
  geom_line() +
  facet_wrap(~compartment)
```
