---
title: "SEIaImIsRD model"
author: "Liangti Dai and David Seiferth"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{SEIaImIsRD model}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(comomodels)
```

## Introduction
This document explains the basics of the SEIaImIsRD model. The model describes
how populations of susceptible ($S$), exposed ($E$), infectious and recovered ($R$)
individuals evolve over time. The infected population is split into different 
symptom compartments: asymptomatic ($I_a$), mild ($I_m$) and severe ($I_s$). 
An ordinary differential equation (ODE) is defined for each of the populations.

The object class `SEIaImIsRD` lets the user define and simulate such a model, 
choosing the initial conditions and parameter values.

## The SEIaImIsRD Model
### Core: the ODE system
The SEIaImIsRD model consists of six ODEs describing the six populations. Susceptible
individuals ($S$) have not been exposed to the virus. Exposed individuals ($E$) have been
exposed to the virus and have been infected but are not yet infectious to others; they are 
in the incubation period. Infectious individuals can spread the virus to others. 
The total initial population size is normalised to 1.
The current model does not include natural death or birth.	
The ODEs describing how these six populations evolve over time are
$$\frac{\text{d}S}{\text{d}t} = -S (\beta_{I_a}I_a + \beta_{I_m}I_m + \beta_{I_s}I_s) + \omega R,$$
where $\beta$ denotes the rate, at which an infected individual exposes susceptible individuals,
and $\omega$ denotes the rate, at which recovered individuals become susceptible.
$$\frac{\text{d}E}{\text{d}t} = S (\beta_{I_a}I_a + \beta_{I_m}I_m + \beta_{I_s}I_s) - \kappa E,$$
where $\kappa$ denotes the rate at which exposed individuals become infected.
$$\frac{dI_{a}}{dt} = \eta_{E->I_a} \kappa E - (\gamma_{I_a} + \mu_{I_a})I_{a},$$


$$\frac{dI_{m}}{dt} = \eta_{E->I_m} \kappa E - (\gamma_{I_m} + \mu_{I_a})I_{m},$$
$$\frac{dI_{s}}{dt} = \eta_{E->I_s} \kappa E - (\gamma_{I_s} + \mu_{I_a})I_{s},$$
where $\eta_{E->I_a}$, $\eta_{E->I_m}$, $\eta_{E->I_s}$ denote the fraction of exposed individuals that develop asymptomatic, mild and symptoms, respectively (in the code the fraction is denoted by 'p_symptom').
The rate, at which each infected group recovers, is denoted by $\gamma_I$.
The rate of disease-caused mortality of each infected group is denoted by $\mu_I$.

$$\frac{\text{d}R}{\text{d}t} = - \omega R +\mu_{I_a}  * I_{a} + \mu_{I_m}  * I_{m} + \mu_{I_s}  * I_{s}.$$

The rate at which susceptible individuals are infected depends on the fraction
of the population that is susceptible, the fraction of the population that is
infectious, and the probability of an infectious individual infecting a 
susceptible individual, $\lambda$. This is represented in the
first terms on the right-hand side of $\text{d}S/ \text{d}t$ and $\text{d}I/ \text{d}t$.
Exposed individuals become infectious at rate $\kappa$. The reciprocal value $1/ \kappa$ is
the incubation time of the virus, i.e. how many days after exposure the individual
becomes infectious to others. Infectious individuals can either recover or die
because of the disease. Infectious individuals in group $i\in {a,m,s}$ recover in $1/ \beta_i$
days, thus individuals recover at rate $\beta_i$. Similarly, infectious
individuals die due to the infection after $1/ \mu_i$ days, making the death rate $\mu_i$.

In addition to these six main ODEs, the model also keeps track the number of 
disease-related deaths ($D$) over time
$$\frac{\text{d}D}{\text{d}t} = - \mu_{I_a} * I_{a} +  \mu_{I_m} * I_{m} +  \mu_{I_s} * I_{s},$$

The system is closed by specifying the initial conditions
$$S(0) = S_0,\ E(0) = E_0,\ I(0) = I_0,\ R(0) = R_0,\ C(0) = C_0,\ D(0) = D_0,$$
In the implementation in this package, the variables are normalized so 
$S(t) + E(t) + I_a(t) + I_m(t) + I_s(t) + R(t) + D(t) \equiv 1$ for any given $t$.

Steady states of the system described above are computed by setting the right-hand
sides of the ODEs equal to zero. 

Because we build on this basic model to develop more complex epidemiological models,
we solve the ODEs over time instead of just solving for the steady states. The
next section shows an example of how to use the SEIR_model class.

### Basic reproduction number
For mathematical details, please refer to [this paper](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6002118/pdf/main.pdf).

We calculate the basic reproduction number ($R_0$) using the next generation matrix approach, given the equation:
$$R_0 = \rho(FV^{-1}),$$
where $F=\frac{\partial F_i{(x_0)}}{\partial x_j}$, $V=\frac{\partial V_i{(x_0)}}{\partial x_j}$ and $\rho$ denotes the spectral radius of a matrix (i.e. the largest absolute value of its eigenvalues).

The $F_i$ are the new infections, while the $V_i$ transfers of infections from one infectious or exposed compartment to another (here, these compartments are $E$, $I_a$, $I_m$ and $I_s$). $x_0$ is the disease-free equilibrium state.

In the SEIaImIsRD model, $F$ and $V$ are $4\times4$ matrices:
$$
F = \left(\begin{array}{cc} 
0 & S_0\beta_{I_a} & S_0\beta_{I_m} & S_0\beta_{I_s}\\
0 & 0 & 0 & 0\\
0 & 0 & 0 & 0\\
0 & 0 & 0 & 0
\end{array}\right), 
V = \left(\begin{array}{cc} 
\kappa & 0 & 0 & 0\\
\kappa \eta_{E->I_a} & \gamma_{I_a} + \mu_{I_a} & 0 & 0\\
\kappa \eta_{E->I_m} & 0 & \gamma_{I_m} + \mu_{I_m} & 0\\
\kappa \eta_{E->I_s} & 0 & 0 & \gamma_{I_s} + \mu_{I_s}
\end{array}\right)
$$

## The `SEIaImIsRD` class
In this section we will walk through an example of how to use the `SEIaImIsRD`
class.

To create a new `SEIaImIsRD` object, run:
```{r}
model <- SEIaImIsRD()
```

Next, we assign values for the fractions of the population.
The initial conditions must sum to one.
```{r}
S <- 0.9
E <- 0.1
I_asymptomatic <- 0
I_mild <- 0
I_severe <- 0
R <- 0
D_cumulative <- 0
```

Then, we define the transition rates:
```{r}
beta <- list(i_asymptomatic = 0.80, i_mild = 0.90, i_severe = 1.00)
kappa <- 0.50
omega <- 0.01
p_symptom <- list(i_mild = 0.35, i_severe = 0.05)
gamma <- list(i_asymptomatic = 0.9, i_mild = 0.50, i_severe = 0.05)
mu <- list(i_asymptomatic = 0.005, i_mild = 0.05, i_severe = 0.30)
```

And, we set time for the simulation:
```{r}
t <- seq(0, 2000, by = 1)
```

We initialise our model with the parameters defined above:
```{r}
model <- set_init(object = model, S = S, E = E, I_asymptomatic = I_asymptomatic, I_mild = I_mild,
                    I_severe = I_severe, R = R, D = D_cumulative,
                    beta = beta, kappa = kappa, omega = omega,
                    p_symptom = p_symptom, gamma = gamma, mu = mu)
```

We use the ode solver, plot the relaxation into the steady state and calculate the R0 of the system by calling the function `R0_SEIaImIsRD`:
```{r}
model <- ode_simulate(model, t)
model <- R0_SEIaImIsRD(model)
p <- plot_dataframe(model@output, x = "time", y = "fraction", c = "population_group")
print(p)
print(paste0("model: R0=", model@R0))
```

Comparison with no natural loss of immunity (no transmission from R to S; omega=0)
```{r}
model1 <- set_init(object = model, S = S, E = E, I_asymptomatic = I_asymptomatic, I_mild = I_mild,
                    I_severe = I_severe, R = R, D = D_cumulative,
                    beta = beta, kappa = kappa, omega = 0.00,
                    p_symptom = p_symptom, gamma = gamma, mu = mu)

model1 <- ode_simulate(model1, t)
model1 <- R0_SEIaImIsRD(model1)
p1 <- plot_dataframe(model1@output, x = "time", y = "fraction", c = "population_group")
print(p1)
print(paste0("model1: R0=", model1@R0))
```

Comparison with altered beta values:
```{r}
beta <- list(i_asymptomatic = 0.50, i_mild = 0.90, i_severe = 1.00)
model2 <- set_init(object = model, S = S, E = E, I_asymptomatic = I_asymptomatic, I_mild = I_mild,
                    I_severe = I_severe, R = R, D = D_cumulative,
                    beta = beta, kappa = kappa, omega = 0.00,
                    p_symptom = p_symptom, gamma = gamma, mu = mu)

model2 <- ode_simulate(model2, t)
model2 <- R0_SEIaImIsRD(model2)
p2 <- plot_dataframe(model2@output, x = "time", y = "fraction", c = "population_group")
print(p2)
print(paste0("model2: R0=", model2@R0))
```

