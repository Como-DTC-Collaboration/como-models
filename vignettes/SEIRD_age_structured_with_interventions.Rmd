---
title: "SEIRD_age_structred_with_interventions"
author: "Oscar Dimdore-Miles, Idil Cazimoglu and Liangti Dai"
date: "28/10/2021"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{The SEIRDAge_interventions model}
  %\VignetteEngine{knitr::knitr}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(comomodels)
library(tidyverse)

# NPI includes school closures, physical distancing, shielding of older people (ie, ≥70 years), self-isolation of symptomatic individuals, and a combination of all four policies. (https://www.thelancet.com/journals/lanpub/article/PIIS2468-2667(20)30133-X/fulltext)
```


Define some functions for plotting and contact matrix processing
```{r}
# color by age groups
ggplot_results_by_compartment <- function(output, x="time", y="value", colour="age_range", 
                                          labs_x = "time (days)", labs_y = "fraction of the population", text_size=20){
  output %>%
  ggplot(aes_string(x=x, y=y, colour=colour)) +
  geom_line() +
  #facet_wrap(~compartment) +
  scale_colour_viridis_d() +
  labs(x = labs_x, y = labs_y) +
  theme(text = element_text(size = text_size))  
}

format_matrix <- function(contact_matrix, age_names) {
  colnames(contact_matrix) <- age_names
  contact_matrix$age_infectee <- age_names
  contact_matrix %>%
    pivot_longer(all_of(age_names)) %>% 
    rename(age_infector=name) %>% 
    mutate(age_infector=fct_relevel(age_infector, age_names)) %>% 
    mutate(age_infectee=fct_relevel(age_infectee, age_names))
}

combine_contact_matrices <- function(c_all){
  c_all %>%
    group_by(age_infectee, age_infector) %>% 
    summarise(value=sum(value))
}


combined_contact_matrices_wider <- function(c_combined){
  c_combined %>% 
    pivot_wider(id_cols = age_infectee, names_from = age_infector,
              values_from=value) %>% 
    ungroup() %>% 
    select(-age_infectee) %>% as.matrix()
} 


```

## Introduction
A key aspect of modeling the spread of COVID-19 is the implementation of **non-pharmaceutical interventions (NPIs)**,  such as self isolating, physical distancing, shielding vulnerable (old) groups, school closure, lockdown, etc. In this vignette, we implement the effect of a number of such interventions and examine their influence on virus transmission using an age structured SEIRD model.

For this vignette we utilise an example case for social contact and subsequent virus transmission. The contact matrices, $C$ indicate the expected number of contacts an individual of age class $i$ experiences with age class $j$ per day. In this package, we include country-level estimates of contact matrices (Prem et al., 2017; for full details see data documentation). There are actually four types of contact matrix corresponding to daily numbers of contacts at home, work, school and all other settings. Here, we visualise these for India.
```{r, fig.width=10, fig.height=8}
# reformat matrices for plotting
ages <- seq(0, 80, 5)
age_names <- vector(length = 16)
for(i in seq_along(age_names)) {
  age_names[i] <- paste0(ages[i], "-", ages[i + 1])
}


c_home <- format_matrix(contact_home$India, age_names) %>% mutate(type="home")
c_work <- format_matrix(contact_work$India, age_names) %>% mutate(type="work")
c_school <- format_matrix(contact_school$India, age_names) %>% mutate(type="school")
c_other <- format_matrix(contact_other$India, age_names) %>% mutate(type="other")

c_all <- c_home %>%
  bind_rows(c_work) %>% 
  bind_rows(c_school) %>% 
  bind_rows(c_other)

# plot all
c_all %>%
  ggplot(aes(x=age_infector, y=age_infectee, fill=value)) +
  geom_tile() +
  scale_fill_viridis_c() +
  facet_wrap(~type)
```

We can see that the majority of contacts fall between younger individuals, occurring at home or "other" locations. At home, however, there is more substantial intergenerational mixing than in other settings.

We make an overall contact matrix by summming contributions from social settings together.
```{r, fig.width=8, fig.height=5}
c_combined <- combine_contact_matrices(c_all)

c_combined %>% 
  ggplot(aes(x=age_infector, y=age_infectee, fill=value)) +
  geom_tile() +
  scale_fill_viridis_c()


```
We now use this contact matrix to allow infections to pass between age groups. To do so, we amend the governing equations for the susceptibles and exposed individuals within age class $i$:

\begin{align}
\frac{\text{d}S_i}{\text{d}t} &= -\beta S_i \Sigma_{j}C_{ij} I_j\\
\frac{\text{d}E_i}{\text{d}t} &= \beta S_i \Sigma_{j}C_{ij} I_j -\kappa E_i\\
\end{align}

Specifically, the term $S_i \Sigma_{j}C_{ij} I_j$ effectively indicates the expected number of contacts between susceptible individuals of age class $i$ with infected individuals across all classes.


## The SEIRDVAge Model
The SEIRDAge_interventions model consists of five ODEs describing five populations of susceptible,
recovered, infectious, recovered and vaccinated individuals. Susceptible
individuals ($S$) have not been exposed to the virus. Exposed individuals ($E$) have been
exposed to the virus and have been infected but are not yet infectious to others; they are 
in the incubation period. Infectious individuals ($I$) can spread the virus to 
others. Recovered individuals ($R$) are no longer
infectious, and no waning immunity is taken into accound. Any NPI strategies can be appied to multiple, 
non-overlapping time periods. Within each intervention period, we allow fully customised setting of
its corresponding **contact matrices** and the **transmisson parameter $\beta$**. 
Births and deaths unrelated to the infection are not considered in
this model. The ODEs describing how the five populations evolve over time are

$$\frac{\text{d}S_i}{\text{d}t} = -\beta_i(t) S_i \Sigma_{j}C_{ij}(t) I_j,$$
$$\frac{\text{d}E_i}{\text{d}t} = \beta_i(t) S_i \Sigma_{j}C{ij}(t) I_j-\kappa E_i,$$
$$\frac{\text{d}I_i}{\text{d}t} = \kappa E_i - (\gamma + \mu) I_i,$$
$$\frac{\text{d}R_i}{\text{d}t} = \gamma I_i,$$

where $i$ represent an age group, and $t$ represents a time point, and:
* $\beta$, $\kappa$, $\gamma$, $\mu_i$, $\nu$, are
positive parameters. The rate at which susceptible individuals are infected
depends on the fraction of the population that is susceptible, the fraction of
the population that is infectious, and the odds of an infectious individual
infecting a susceptible individual, $\beta_i(t)$,.This is represented in the
first terms on the right-hand side of $\text{d}S/ \text{d}t$ and $\text{d}E/ \text{d}t$. 
In this model, we consider $\beta$ to be time and age dependent, because the type and 
time interval of each intervention can be different, and interventions can be applied 
differently onto each age group. 

* Exposed individuals become infectious at rate $\kappa$. $1/ \kappa$ is
the incubation time of the virus, i.e. how many days after exposure the individual
becomes infectious to others. Infectious individuals can either recover or die
because of the disease. 

* Infectious individuals recover in $1/ \gamma$
days, thus individuals recover at rate $\gamma$. 

* Infectious individuals die due to the infection after $1/ \mu_i$ days. In this model
we consider different mortality rate for each age group, because different age groups
exibit different vulnerablility to the infection.

* The contact matrix $C_{ij}(t)$ is also considered time dependent in this model, because
NPIs can change the contact rates for certain or all age groups.

In addition to these five main ODEs, the model also keeps track of the cumulative number 
of cases ($C$) and the cumulative number of disease-related deaths ($D$) over time
$$\frac{\text{d}C_i}{\text{d}t} = \beta(t) S_i \Sigma_{j}C_{ij}(t) I_j,$$
$$\frac{\text{d}D_i}{\text{d}t} = \mu_i I_i.$$

The system is closed by specifying the initial conditions
$$S(0) = S_0,\ E(0) = E_0,\ I(0) = I_0,\ R(0) = R_0, \ C(0) = 0,\ D(0) = 0.$$
In the implementation of the model in this package, the variables are normalized so 
$S(t) + E(t) + I(t) + R(t) + D(t) \equiv 1$ for any given $t$. This means that each of these state variables represents the fraction of the population in each of these states at a given point in time.

We next illustrate how this model works using functionality available in `comomodels` through several simulation processes.

## The `SEIRDAge_interventions` class


## Simulation examples

Now we create a model that includes this age-structured mixing. Since the contact matrices have 16 age classes, we instantiate a model with this number of classes. We also give it transmission parameters, populate the age classes with initial conditions and use our overall contact matrix.

We use country-level demographics from the UN and, for this example, initialise the model with a uniform initial infected population of 1% across all age groups. The remaining 99% of the population starts as susceptibles. 

We start from a simple scenario: a single intervention period that has a reduced rate in the connections between all age groups, and a reduced infectious transmission rate.
```{r}
load(file = "../data/population.rda")
# use demographic data to create normalised population fractions
pops = population[population$country == 'India', ]$pop
pop_fraction = pops/sum(pops)
## the contact matrix has an upper group of 80+, so we sum the remaining fractions beyond this point
pop_fraction[16] = sum(pop_fraction[16:21])
pop_fraction = pop_fraction[1:16]
# reshape contact matrix into 16x16 form
n_ages <- 16
c_combined_wider <- combined_contact_matrices_wider(c_combined)

# create model
n_interventions = 1 # only one intervention
my_model <- SEIRDAge_interventions(n_age_categories = n_ages,
                                   n_interventions = n_interventions,
                                   contact_matrix = c_combined_wider,
                                   contact_matrix_interventions = list(c_combined_wider*0.5),
                                   age_ranges = as.list(age_names)
)
```

Next, we set the parameter values for $\beta$, $\kappa$, $\gamma$, $\mu$, $\nu$,
$\delta_V$, $\delta_R$ and $\delta_{VR}$. For results inspired by the COVID pandemic,
the mortality parameter $\mu$ is age-dependent as according to [Verity (2020)](https://www.medrxiv.org/content/early/2020/03/13/2020.03.09.20033357):
```{r}
mu <- c(0.000016, 0.000016, 0.00007, 0.00007, 0.00031, 0.00031, 0.0026, 0.0026,
     0.0048, 0.0048, 0.006, 0.006, 0.019, 0.019, 0.043, 0.043)

params <- list(beta_interventions = 0.65, beta = 1,
               kappa = 0.9, gamma = 0.5, mu = mu)
transmission_parameters(my_model) <- params
```

To check that the parameters have been set correctly, we call
```{r}
transmission_parameters(my_model)
```


We now need to set the initial conditions for the model. We only set the initial conditions $S(0)$, $E(0)$, $I(0)$, $R(0)$, $V(0)$ and $VR(0)$.
```{r}
initial_conditions(my_model) <- list(S0=pop_fraction*0.99,
                                     E0=rep(0, n_ages),
                                     I0=pop_fraction*0.01,
                                     R0=rep(0, n_ages),
                                     D0=rep(0, n_ages)
                                     )
```


The initial conditions must sum to one. If they do not, an error is thrown.

Now we simulate the system from $t=0$ days to $t=100$ days, with a single intervention between $t=5$ and $t=20$.
```{r}
# interven <- list(list("starts"=5, "stops"=20, "coverages"=1),
#                  list("starts"=50, "stops"=70, "coverages"=1),
#                  list("starts"=100, "stops"=130, "coverages"=1))

interven <- list(list("starts"=5, "stops"=20, "coverages"=1))

interventions(my_model) <- interven
times <- seq(0, 100, by = 1)
out_df <- run(my_model, times)
```


Let us plot the population size for each epidemiological group and each age group.
```{r, fig.height = 5, fig.width = 10}
states = out_df$states
states %>% ggplot_results_by_compartment() +
  facet_wrap(~compartment)
```

We see that the intervention


Zooming in on the infected population, we see that the younger age groups have the highest peak infected population levels.
```{r, fig.width=8, fig.height=5}
states %>%
  filter(compartment=="I") %>% 
  ggplot_results_by_compartment() +
  facet_wrap(~compartment)
```


The simulation also outputs incidence and deaths. These are derived from the state variables. Incidence is just the difference between the cumulative number of cases between two time points,

$$ \text{incidence(t)} = C(t) - C(t - 1),$$

since this shows the number of cases which have arisen between these time  points. Deaths are also given by a difference, but, in this instance, between the cumulative number of deaths at two consecutive time points:

$$ \text{deaths(t)} = D(t) - D(t - 1).$$

```{r fig2, fig.height = 5, fig.width = 7}
changes <- out_df$changes
changes %>%
  filter(compartment=="Incidence") %>% 
  ggplot_results_by_compartment(labs_y = "fraction of the population \n that is newly infected per day")
changes %>%
  filter(compartment=="Deaths") %>% 
  ggplot_results_by_compartment(labs_y = "fraction of the population \n that died per day")

```



## Sensitivity analysis


Different non-pharmaceutical interventions introduce different changes 
in contact rates and infectiousness of the infected individuals. 
In the model, the differences present on the values of contact matrices 
and $beta_interventions$. We now explore several NPI scenarios: **physical distancing**, **self-isolation of the infected groups**, **school closures**, **shielding of older population groups (ie, ≥70 years)**, and a combination of them (**lockdown**). 

For the parameters of each scenario, we adopt the settings from [Davies, et.al. (2020)](https://doi.org/10.1016/S2468-2667(20)30133-X).

We introduce the intervention into the outbreak period of the epidemic.


In this section, we investigate the sensitivity of different starting time.

```{r, fig.height = 5, fig.width = 10}
run_SEIRDAge_interventions_single_intv <- function(beta_interventions, contact_matrix_interventions) {
  inits <- list(S0=pop_fraction*0.99,
                E0=rep(0, n_ages),
                I0=pop_fraction*0.01,
                R0=rep(0, n_ages),
                D0=rep(0, n_ages)
                )
  mu <- c(0.000016, 0.000016, 0.00007, 0.00007, 0.00031, 0.00031, 0.0026, 0.0026,
     0.0048, 0.0048, 0.006, 0.006, 0.019, 0.019, 0.043, 0.043)
  params <- list(beta_interventions = beta_interventions, beta = 1,
               kappa = 0.9, gamma = 0.5, mu = mu)
  model <- SEIRDAge_interventions(
    n_age_categories = n_ages,
    n_interventions = 1,
    contact_matrix = c_combined_wider,
    contact_matrix_interventions = contact_matrix_interventions,
    age_ranges = as.list(age_names),
    initial_conditions = inits,
    transmission_parameters=params,
    interventions = list(list("starts"=5, "stops"=20, "coverages"=1)))
  times <- seq(0, 100, by = 1)
  out_df <- run(model, times)
  out_df
}



# run model for different scenarios
## basline (baseline: no interventions at all)
model_base <- run_SEIRDAge_interventions_single_intv(1, list(c_combined_wider))
result <- model_base$changes %>% mutate(scenario="baseline")
result_states <- model_base$states %>% mutate(scenario="baseline")


## physical distancing: work and other contact values become 50% of baseline
c_work_pd <- c_work
c_work_pd$value <- c_work$value * 0.5
c_other_pd <- c_other
c_other_pd$value <- c_other$value * 0.5

c_combined_wider_pd <- c_home %>%
  bind_rows(c_work_pd) %>% 
  bind_rows(c_school) %>% 
  bind_rows(c_other_pd) %>% 
  combine_contact_matrices() %>% 
  combined_contact_matrices_wider()

model_pd <- run_SEIRDAge_interventions_single_intv(1, list(c_combined_wider_pd))
result <- result %>% bind_rows(model_pd$changes %>% mutate(scenario="physical distancing"))
result_states <- result_states %>% bind_rows(model_pd$states %>% mutate(scenario="physical distancing"))

## self-isolation of the infected groups: beta_intervention = beta * 0.65
model_si <- run_SEIRDAge_interventions_single_intv(0.65*1, list(c_combined_wider))
result <- result %>% bind_rows(model_si$changes %>% mutate(scenario="self-isolation"))
result_states <- result_states %>% bind_rows(model_si$states %>% mutate(scenario="self-isolation"))

## school closures: no school contacts
c_combined_wider_sc <- c_home %>%
  bind_rows(c_work) %>% 
  #bind_rows(c_school*0) %>% 
  bind_rows(c_other) %>% 
  combine_contact_matrices() %>% 
  combined_contact_matrices_wider()

model_sc <- run_SEIRDAge_interventions_single_intv(1, list(c_combined_wider_sc))
result <- result %>% bind_rows(model_sc$changes %>% mutate(scenario="school closure"))
result_states <- result_states %>% bind_rows(model_sc$states %>% mutate(scenario="school closure"))

## shielding of older population groups: in work contacts and other contacts, the contact rates of >70 yrs (either contactor or contactee) become 25% of baseline. ??? would >70 - >70 contact rate be further reduced?
age_old_work <- (lapply(c_work$age_infector %>% as.character(), function(age) as.integer(strsplit(age, "-")[[1]][1]) >= 70) %>% unlist) | (lapply(c_work$age_infectee %>% as.character(), function(age) as.integer(strsplit(age, "-")[[1]][1]) >= 70) %>% unlist)
age_old_other <- (lapply(c_other$age_infector %>% as.character(), function(age) as.integer(strsplit(age, "-")[[1]][1]) >= 70) %>% unlist) | (lapply(c_other$age_infectee %>% as.character(), function(age) as.integer(strsplit(age, "-")[[1]][1]) >= 70) %>% unlist)

c_work_so = c_work
c_work_so[age_old_work, "value"] = c_work[age_old_work, "value"]*0.25

c_other_so = c_other
c_other_so[age_old_other, "value"] = c_work[age_old_other, "value"]*0.25

c_combined_wider_so <- c_home %>%
  bind_rows(c_work_so) %>% 
  bind_rows(c_school) %>% 
  bind_rows(c_other_so) %>% 
  combine_contact_matrices() %>% 
  combined_contact_matrices_wider()
model_so <- run_SEIRDAge_interventions_single_intv(1, list(c_combined_wider_so))
result <- result %>% bind_rows(model_so$changes %>% mutate(scenario="shielding of older"))
result_states <- result_states %>% bind_rows(model_so$states %>% mutate(scenario="shielding of older"))

## lockdown: work, other, school -> 10%, beta -> 0.65
c_work_l <- c_work
c_work_l$value <- c_work$value * 0.1
c_school_l <- c_school
c_school_l$value <- c_school$value * 0.1
c_other_l <- c_other
c_other_l$value <- c_other$value * 0.1

c_combined_wider_l <- c_home %>%
  bind_rows(c_work_l) %>% 
  bind_rows(c_school_l) %>% 
  bind_rows(c_other_l) %>% 
  combine_contact_matrices() %>% 
  combined_contact_matrices_wider()
model_l <- run_SEIRDAge_interventions_single_intv(0.65*1, list(c_combined_wider_l))
result <- result %>% bind_rows(model_l$changes %>% mutate(scenario="lockdown"))
result_states <- result_states %>% bind_rows(model_l$states %>% mutate(scenario="lockdown"))



# plot results
result_states %>% 
  filter(compartment=="S" | compartment=="R") %>% 
  ggplot_results_by_compartment(text_size = 15) + 
  facet_grid(compartment ~ scenario)

result_states %>% 
  filter(compartment=="I" | compartment=="E") %>% 
  ggplot_results_by_compartment(text_size = 15) + 
  facet_grid(compartment ~ scenario)

result %>% 
  filter(compartment=="Deaths") %>%
  ggplot_results_by_compartment(labs_y="fraction of the population \n that died per day", text_size = 15) +
  facet_wrap(~scenario)

result %>% 
  filter(compartment=="Incidence") %>% 
  ggplot_results_by_compartment(labs_y="fraction of the population \n that is newly infected per day", text_size = 15) +
  facet_wrap(~scenario)


```

We can observe different interference results between the five NPI scenarios. 
Apart from __sheilding of the older age groups (so)__ where the reduced deaths 
and transmissions are mostly restricted with the older age group,
all other interventions present the inteference of virus transmission, reduced 
number of infected cases and reduced deaths. Looking at the change of the 
Incidence, although in all scenarios except __so__ , the reduction to the rate of transmission 
start as soon as the intervention begeins and reach to a lower maximum level. 
only __lockdown__ controls the outbreak rapidly and thouroughly, 
However, as the lockdown intervention lifts, the ungoing epidemic still arouses a second, 
though milder outpeak. This suggests that even a short but stringent NPI, 
such as lockdown, can still be one of the best intervention to alleviate and defer an outbreak, 
which can potentially open a valuable time window for people to develop more
comprehensive and specific long-term strategies when facing an unexpected
infectious disease.



In this section, we further explore the combinations of different NPI scenarios. 
This time we focus on the effect of different ordering of NPIs. 
Here we focus on two NPIs, self-isolation and physical distancing.
```{r}
run_SEIRDAge_interventions_mult_intv <- function(beta_interventions, contact_matrix_interventions, n_interventions) {
  inits <- list(S0=pop_fraction*0.99,
                E0=rep(0, n_ages),
                I0=pop_fraction*0.01,
                R0=rep(0, n_ages),
                D0=rep(0, n_ages)
                )
  mu <- c(0.000016, 0.000016, 0.00007, 0.00007, 0.00031, 0.00031, 0.0026, 0.0026,
     0.0048, 0.0048, 0.006, 0.006, 0.019, 0.019, 0.043, 0.043)
  params <- list(beta_interventions = beta_interventions, beta = 1,
               kappa = 0.9, gamma = 0.5, mu = mu)
  model <- SEIRDAge_interventions(
    n_age_categories = n_ages,
    n_interventions = n_interventions,
    contact_matrix = c_combined_wider,
    contact_matrix_interventions = contact_matrix_interventions,
    age_ranges = as.list(age_names),
    initial_conditions = inits,
    transmission_parameters=params,
    interventions = list(list("starts"=5, "stops"=10, "coverages"=1),
                         list("starts"=28, "stops"=35, "coverages"=1)))
  times <- seq(0, 100, by = 1)
  out_df <- run(model, times)
  out_df
}



# run model for different scenarios
## basline (baseline: no interventions at all)
result <- model_base$changes %>% mutate(scenario="baseline")
result_states <- model_base$states %>% mutate(scenario="baseline")


model_pd_pd <- run_SEIRDAge_interventions_mult_intv(c(1, 1), 
                                                    list(c_combined_wider_pd, c_combined_wider_pd),
                                                    2)
result <- result %>% bind_rows(model_pd_pd$changes %>% mutate(scenario="pd-pd"))
result_states <- result_states %>% bind_rows(model_pd_pd$states %>% mutate(scenario="pd-pd"))

## self-isolation of the infected groups: beta_intervention = beta * 0.65
model_si_si <- run_SEIRDAge_interventions_mult_intv(c(0.65*1, 0.65*1),
                                                      list(c_combined_wider, c_combined_wider),
                                                      2)
result <- result %>% bind_rows(model_si_si$changes %>% mutate(scenario="si-si"))
result_states <- result_states %>% bind_rows(model_si_si$states %>% mutate(scenario="si-si"))

model_pd_si <- run_SEIRDAge_interventions_mult_intv(c(1, 0.65*1), 
                                                      list(c_combined_wider_pd, c_combined_wider),
                                                      2)
result <- result %>% bind_rows(model_pd_si$changes %>% mutate(scenario="pd-si"))
result_states <- result_states %>% bind_rows(model_pd_si$states %>% mutate(scenario="pd-si"))

model_si_pd <- run_SEIRDAge_interventions_mult_intv(c(0.65*1, 1), 
                                                      list(c_combined_wider, c_combined_wider_pd),
                                                      2)
result <- result %>% bind_rows(model_si_pd$changes %>% mutate(scenario="si-pd"))
result_states <- result_states %>% bind_rows(model_si_pd$states %>% mutate(scenario="si-pd"))


# plot results
result_states %>% 
  filter(compartment=="S" | compartment=="R") %>% 
  ggplot_results_by_compartment(text_size = 15) + 
  facet_grid(compartment ~ scenario)

result_states %>% 
  filter(compartment=="I" | compartment=="E") %>% 
  ggplot_results_by_compartment(text_size = 15) + 
  facet_grid(compartment ~ scenario)

result %>% 
  filter(compartment=="Deaths") %>%
  ggplot_results_by_compartment(labs_y="fraction of the population \n that died per day", text_size = 15) +
  facet_wrap(~scenario)

result %>% 
  filter(compartment=="Incidence") %>% 
  ggplot_results_by_compartment(labs_y="fraction of the population \n that is newly infected per day", text_size = 15) +
  facet_wrap(~scenario)

```

We can see different intervention results of the epidemic under different combinations of NPIs.



